<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procuti RRI Sibolga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBBDMhvpAboYaEUIfo0eyzjZxK6iZyQwpo",
            authDomain: "cutirri.firebaseapp.com",
            projectId: "cutirri",
            storageBucket: "cutirri.firebasestorage.app",
            messagingSenderId: "310950239670",
            appId: "1:310950239670:web:3b58351db2c5946f8c3517",
            measurementId: "G-BENDLYTZ2Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions available globally
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot };
    </script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* Enhanced Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .slide-down {
            animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3) rotate(-10deg); }
            50% { opacity: 1; transform: scale(1.05) rotate(2deg); }
            70% { transform: scale(0.9) rotate(-1deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        @keyframes pulseGlow {
            from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            to { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6), 0 0 40px rgba(59, 130, 246, 0.2); }
        }
        
        /* Floating Animation */
        .float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Glass Morphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* Neon Glow Effect */
        .neon-border {
            border: 2px solid;
            border-image: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff) 1;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.3);
        }
        
        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Button Ripple Effect */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }
        .btn-ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: width 0.6s, height 0.6s;
            transform: translate(-50%, -50%);
        }
        .btn-ripple:active::before {
            width: 300px;
            height: 300px;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Particle Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            animation: particleFloat 15s infinite linear;
        }
        
        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Statistics Counter Animation */
        .counter {
            font-variant-numeric: tabular-nums;
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #ff006e, #8338ec, #3a86ff);
            border-radius: 2px;
            animation: progressGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes progressGlow {
            from { box-shadow: 0 0 5px rgba(255, 0, 110, 0.5); }
            to { box-shadow: 0 0 20px rgba(255, 0, 110, 0.8); }
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .tooltip:hover::after {
            opacity: 1;
        }
        
        /* Responsive Grid Animation */
        .grid-item {
            animation: gridSlideIn 0.6s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes gridSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .glass-card {
                background: rgba(0, 0, 0, 0.25);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
        
        /* Crop handles styling */
        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: all;
            z-index: 10;
        }
        
        .crop-handle[data-handle="nw"] { top: -6px; left: -6px; cursor: nw-resize; }
        .crop-handle[data-handle="ne"] { top: -6px; right: -6px; cursor: ne-resize; }
        .crop-handle[data-handle="sw"] { bottom: -6px; left: -6px; cursor: sw-resize; }
        .crop-handle[data-handle="se"] { bottom: -6px; right: -6px; cursor: se-resize; }
        .crop-handle[data-handle="n"] { top: -6px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .crop-handle[data-handle="s"] { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .crop-handle[data-handle="w"] { top: 50%; left: -6px; transform: translateY(-50%); cursor: w-resize; }
        .crop-handle[data-handle="e"] { top: 50%; right: -6px; transform: translateY(-50%); cursor: e-resize; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-indigo-100 min-h-screen relative overflow-x-hidden">
    <!-- Animated Particle Background -->
    <div class="particles" id="particles"></div>
    
    <!-- Floating Geometric Shapes -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-20 left-10 w-20 h-20 bg-blue-200 rounded-full opacity-20 float" style="animation-delay: 0s;"></div>
        <div class="absolute top-40 right-20 w-16 h-16 bg-purple-200 rounded-lg opacity-20 float" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-40 left-20 w-12 h-12 bg-pink-200 rounded-full opacity-20 float" style="animation-delay: 2s;"></div>
        <div class="absolute bottom-20 right-40 w-24 h-24 bg-indigo-200 rounded-lg opacity-20 float" style="animation-delay: 0.5s;"></div>
    </div>
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="fixed top-4 right-4 bg-white rounded-lg shadow-lg p-3 z-50 hidden">
        <div class="flex items-center space-x-2">
            <div class="loading"></div>
            <span class="text-sm text-gray-600">Menyinkronkan data...</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-2xl border-b-4 border-gradient-to-r from-red-500 to-pink-500 relative z-10">
        <div class="absolute inset-0 bg-gradient-to-r from-red-500/5 to-pink-500/5"></div>
        <div class="container mx-auto px-6 py-4 relative">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center shadow-lg pulse-glow">
                        <span class="text-white text-2xl animate-pulse">📻</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">Procuti RRI Sibolga</h1>
                        <div class="progress-bar w-32 mt-1"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="modeIndicator" class="px-4 py-2 rounded-full text-sm font-medium bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 shadow-md border border-blue-200 tooltip" data-tooltip="Status login saat ini">
                        Mode: Pengguna
                    </div>
                    <button id="loginBtn" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-6 py-2 rounded-lg font-medium transition-all duration-300 shadow-lg hover:shadow-xl btn-ripple transform hover:scale-105">
                        🔐 Login Admin
                    </button>
                    <button id="logoutBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-all duration-300 shadow-lg hover:shadow-xl btn-ripple transform hover:scale-105 hidden">
                        🚪 Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Pegawai -->
            <div class="glass-card rounded-2xl shadow-2xl p-6 border-l-4 border-blue-500 card-hover bounce-in relative overflow-hidden" style="animation-delay: 0.1s;">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-400/20 to-blue-600/20 rounded-full -mr-10 -mt-10"></div>
                <div class="flex items-center justify-between relative z-10">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Total Pegawai</h3>
                        <p class="text-4xl font-bold bg-gradient-to-r from-blue-500 to-blue-700 bg-clip-text text-transparent counter" id="totalEmployees">0</p>
                        <div class="w-16 h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full mt-2"></div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg float">
                        <span class="text-white text-2xl">👥</span>
                    </div>
                </div>
            </div>

            <!-- Jenis Cuti Terbanyak -->
            <div class="glass-card rounded-2xl shadow-2xl p-6 border-l-4 border-green-500 card-hover bounce-in relative overflow-hidden" style="animation-delay: 0.2s;">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-400/20 to-green-600/20 rounded-full -mr-10 -mt-10"></div>
                <div class="flex items-center justify-between relative z-10">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Jenis Cuti Terbanyak</h3>
                        <p class="text-xl font-bold bg-gradient-to-r from-green-500 to-green-700 bg-clip-text text-transparent" id="mostUsedLeaveType">-</p>
                        <p class="text-sm text-gray-600 counter" id="mostUsedLeaveCount">0 hari</p>
                        <div class="w-16 h-1 bg-gradient-to-r from-green-400 to-green-600 rounded-full mt-2"></div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl flex items-center justify-center shadow-lg float" style="animation-delay: 0.5s;">
                        <span class="text-white text-2xl">📊</span>
                    </div>
                </div>
            </div>

            <!-- Total Cuti Keseluruhan -->
            <div class="glass-card rounded-2xl shadow-2xl p-6 border-l-4 border-red-500 card-hover bounce-in relative overflow-hidden" style="animation-delay: 0.3s;">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-red-400/20 to-red-600/20 rounded-full -mr-10 -mt-10"></div>
                <div class="flex items-center justify-between relative z-10">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Total Cuti Keseluruhan</h3>
                        <p class="text-4xl font-bold bg-gradient-to-r from-red-500 to-red-700 bg-clip-text text-transparent counter" id="totalAllLeaves">0</p>
                        <p class="text-sm text-gray-600">hari</p>
                        <div class="w-16 h-1 bg-gradient-to-r from-red-400 to-red-600 rounded-full mt-2"></div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-red-400 to-red-600 rounded-2xl flex items-center justify-center shadow-lg float" style="animation-delay: 1s;">
                        <span class="text-white text-2xl">📅</span>
                    </div>
                </div>
            </div>

            <!-- Pegawai Cuti Hari Ini -->
            <div class="glass-card rounded-2xl shadow-2xl p-6 border-l-4 border-orange-500 card-hover bounce-in relative overflow-hidden cursor-pointer" style="animation-delay: 0.4s;" onclick="showTodayLeaveModal()">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-orange-400/20 to-orange-600/20 rounded-full -mr-10 -mt-10"></div>
                <div class="flex items-center justify-between relative z-10">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Cuti Hari Ini</h3>
                        <p class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-orange-700 bg-clip-text text-transparent counter" id="todayLeaveCount">0</p>
                        <p class="text-sm text-gray-600">pegawai</p>
                        <div class="w-16 h-1 bg-gradient-to-r from-orange-400 to-orange-600 rounded-full mt-2"></div>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-orange-400 to-orange-600 rounded-2xl flex items-center justify-center shadow-lg float" style="animation-delay: 1.5s;">
                        <span class="text-white text-2xl">🏖️</span>
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500 bg-orange-50 rounded-lg p-2 border border-orange-100">
                    💡 Klik untuk melihat detail pegawai yang cuti hari ini
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- User Actions -->
            <div class="glass-card rounded-2xl shadow-2xl p-8 border-l-4 border-blue-500 card-hover bounce-in relative overflow-hidden" style="animation-delay: 0.4s;">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-400/10 to-blue-600/10 rounded-full -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <h2 class="text-2xl font-bold gradient-text mb-6 flex items-center">
                        <span class="mr-3 text-3xl">📋</span>
                        Layanan Cuti
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <button onclick="ajukanCuti()" class="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white px-6 py-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-3 shadow-lg hover:shadow-xl btn-ripple transform hover:scale-105 tooltip" data-tooltip="Buat permohonan cuti baru">
                            <span class="text-xl">📝</span>
                            <span>Ajukan Cuti</span>
                        </button>
                        <button onclick="unduhBerkas()" class="bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white px-6 py-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-3 shadow-lg hover:shadow-xl btn-ripple transform hover:scale-105 tooltip" data-tooltip="Download formulir dan dokumen">
                            <span class="text-xl">📄</span>
                            <span>Unduh Berkas</span>
                        </button>
                    </div>
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                        <p class="text-sm text-gray-700 leading-relaxed">
                            💡 <strong>Tips:</strong> Ajukan permohonan cuti atau unduh formulir persyaratan yang diperlukan dengan mudah
                        </p>
                    </div>
                </div>
            </div>

            <!-- Admin Controls -->
            <div id="adminControls" class="hidden glass-card rounded-2xl shadow-2xl p-8 border-l-4 border-red-500 card-hover bounce-in relative overflow-hidden" style="animation-delay: 0.5s;">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-red-400/10 to-red-600/10 rounded-full -mr-16 -mt-16"></div>
                <div class="relative z-10">
                    <h2 class="text-2xl font-bold gradient-text mb-6 flex items-center">
                        <span class="mr-3 text-3xl">⚙️</span>
                        Panel Admin
                    </h2>
                    <button id="addEmployeeBtn" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-6 py-4 rounded-xl font-medium transition-all duration-300 flex items-center justify-center space-x-3 w-full shadow-lg hover:shadow-xl btn-ripple transform hover:scale-105 tooltip" data-tooltip="Tambah pegawai baru ke sistem">
                        <span class="text-xl">👤</span>
                        <span>Tambah Pegawai</span>
                    </button>
                    <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-4 border border-red-100 mt-4">
                        <p class="text-sm text-gray-700 leading-relaxed">
                            🔐 <strong>Admin Mode:</strong> Kelola data pegawai dan informasi cuti dalam sistem
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="glass-card rounded-2xl shadow-2xl p-6 mb-8 border-l-4 border-purple-500 card-hover bounce-in relative overflow-hidden" style="animation-delay: 0.6s;">
            <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-400/10 to-indigo-400/10 rounded-full -mr-16 -mt-16"></div>
            <div class="relative z-10">
                <h2 class="text-2xl font-bold gradient-text mb-6 flex items-center">
                    <span class="mr-3 text-3xl">🔍</span>
                    Cari Pegawai
                </h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Ketik nama pegawai, NIP, atau jabatan..." 
                            class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300 bg-white/80 backdrop-blur-sm"
                        >
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <span class="text-lg">🔍</span>
                        </div>
                    </div>
                    <button 
                        id="clearSearch" 
                        class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl btn-ripple transform hover:scale-105 tooltip hidden" 
                        data-tooltip="Hapus pencarian dan tampilkan semua"
                    >
                        ❌ Bersihkan
                    </button>
                </div>
                <div id="searchResults" class="mt-4 text-sm text-gray-600 hidden">
                    <span id="searchResultText"></span>
                </div>
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-100 mt-4">
                    <p class="text-sm text-gray-700 leading-relaxed">
                        💡 <strong>Tips:</strong> Anda dapat mencari berdasarkan nama lengkap, sebagian nama, NIP, atau jabatan pegawai
                    </p>
                </div>
            </div>
        </div>

        <!-- Employee Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="employeeGrid">
            <!-- Employee cards will be dynamically generated here -->
        </div>
    </main>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 slide-down">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Admin</h3>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors">
                        Login
                    </button>
                    <button type="button" id="cancelLogin" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium transition-colors">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 slide-down">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Tambah Pegawai</h3>
            <form id="addEmployeeForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nama Pegawai</label>
                    <input type="text" id="employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">NIP</label>
                    <input type="text" id="employeeNIP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Jabatan</label>
                    <input type="text" id="employeePosition" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-green-600 hover:green-700 text-white py-3 rounded-lg font-medium transition-colors">
                        <span id="addEmployeeSpinner" class="loading hidden mr-2"></span>
                        Tambah
                    </button>
                    <button type="button" id="cancelAddEmployee" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium transition-colors">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 slide-down">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Edit Data Pegawai</h3>
            <form id="editEmployeeForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Nama Pegawai</label>
                    <input type="text" id="editEmployeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">NIP</label>
                    <input type="text" id="editEmployeeNIP" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Jabatan</label>
                    <input type="text" id="editEmployeePosition" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-medium transition-colors">
                        <span id="editEmployeeSpinner" class="loading hidden mr-2"></span>
                        Simpan
                    </button>
                    <button type="button" id="cancelEditEmployee" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium transition-colors">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Upload Modal -->
    <div id="photoUploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 slide-down max-h-[95vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Upload & Edit Foto Pegawai</h3>
            
            <!-- File Upload -->
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Pilih Foto</label>
                <input type="file" id="photoInput" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG, GIF (Max: 5MB)</p>
            </div>

            <!-- Photo Preview -->
            <div id="photoPreview" class="hidden mb-6">
                <label class="block text-gray-700 text-sm font-medium mb-2">Preview Foto</label>
                <div class="relative">
                    <img id="previewImage" class="w-full h-64 object-cover rounded-lg border cursor-pointer" alt="Preview">
                    <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                        <div class="text-white text-center">
                            <p class="text-sm font-medium">🎨 Klik untuk Edit Foto</p>
                            <p class="text-xs">Crop, zoom, filter, dan atur posisi</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Photo Editor -->
            <div id="photoEditor" class="hidden mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Canvas Area -->
                    <div class="lg:col-span-2">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Editor Foto</label>
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 400px;">
                            <canvas id="photoCanvas" class="absolute inset-0 cursor-move border rounded-lg bg-white shadow-inner"></canvas>
                            <!-- Crop overlay -->
                            <div id="cropOverlay" class="absolute inset-0 pointer-events-none">
                                <div class="absolute border-2 border-blue-500 bg-blue-500 bg-opacity-20 rounded" id="cropBox" style="display: none;"></div>
                                <!-- Crop handles -->
                                <div id="cropHandles" style="display: none;">
                                    <div class="crop-handle nw-resize" data-handle="nw"></div>
                                    <div class="crop-handle ne-resize" data-handle="ne"></div>
                                    <div class="crop-handle sw-resize" data-handle="sw"></div>
                                    <div class="crop-handle se-resize" data-handle="se"></div>
                                    <div class="crop-handle n-resize" data-handle="n"></div>
                                    <div class="crop-handle s-resize" data-handle="s"></div>
                                    <div class="crop-handle w-resize" data-handle="w"></div>
                                    <div class="crop-handle e-resize" data-handle="e"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Canvas Controls -->
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button type="button" id="enableCrop" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                                ✂️ Crop Mode
                            </button>
                            <button type="button" id="applyCrop" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium hidden">
                                ✅ Terapkan Crop
                            </button>
                            <button type="button" id="cancelCrop" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm font-medium hidden">
                                ❌ Batal Crop
                            </button>
                            <button type="button" id="fitToCanvas" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-medium">
                                📐 Fit Canvas
                            </button>
                            <button type="button" id="centerImage" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-medium">
                                🎯 Center
                            </button>
                        </div>
                    </div>

                    <!-- Controls Panel -->
                    <div class="space-y-6">
                        <!-- Transform Controls -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3">🔄 Transform</h4>
                            
                            <!-- Zoom -->
                            <div class="mb-4">
                                <label class="block text-xs text-gray-600 mb-1">Zoom: <span id="zoomValue">100%</span></label>
                                <input type="range" id="zoomSlider" min="10" max="500" value="100" class="w-full">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>10%</span>
                                    <span>500%</span>
                                </div>
                            </div>

                            <!-- Position -->
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">X Position</label>
                                    <input type="number" id="positionX" class="w-full px-2 py-1 border rounded text-sm" value="0">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Y Position</label>
                                    <input type="number" id="positionY" class="w-full px-2 py-1 border rounded text-sm" value="0">
                                </div>
                            </div>

                            <!-- Rotation -->
                            <div class="mb-4">
                                <label class="block text-xs text-gray-600 mb-1">Rotation: <span id="rotationValue">0°</span></label>
                                <input type="range" id="rotationSlider" min="0" max="360" value="0" class="w-full">
                            </div>

                            <!-- Quick Rotation -->
                            <div class="flex space-x-2">
                                <button type="button" id="rotateLeft" class="flex-1 bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-sm">↺ -90°</button>
                                <button type="button" id="rotateRight" class="flex-1 bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-sm">↻ +90°</button>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3">🎨 Filters</h4>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Brightness: <span id="brightnessValue">100%</span></label>
                                    <input type="range" id="brightnessSlider" min="0" max="200" value="100" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Contrast: <span id="contrastValue">100%</span></label>
                                    <input type="range" id="contrastSlider" min="0" max="200" value="100" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Saturation: <span id="saturationValue">100%</span></label>
                                    <input type="range" id="saturationSlider" min="0" max="200" value="100" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Blur: <span id="blurValue">0px</span></label>
                                    <input type="range" id="blurSlider" min="0" max="10" value="0" class="w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Preset Actions -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3">⚡ Quick Actions</h4>
                            <div class="space-y-2">
                                <button type="button" id="flipHorizontal" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm">
                                    ↔️ Flip Horizontal
                                </button>
                                <button type="button" id="flipVertical" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm">
                                    ↕️ Flip Vertical
                                </button>
                                <button type="button" id="resetPhoto" class="w-full bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded text-sm">
                                    🔄 Reset All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex space-x-4">
                <button type="button" id="savePhoto" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition-colors">
                    <span id="savePhotoSpinner" class="loading hidden mr-2"></span>
                    💾 Simpan Foto
                </button>
                <button type="button" id="cancelPhotoUpload" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium transition-colors">
                    ❌ Batal
                </button>
            </div>
        </div>
    </div>

    <!-- Today's Leave Modal -->
    <div id="todayLeaveModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 slide-down max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                    <span class="mr-3 text-3xl">🏖️</span>
                    Pegawai Cuti Hari Ini
                    <span class="ml-3 text-sm bg-orange-100 text-orange-800 px-3 py-1 rounded-full" id="todayDateDisplay"></span>
                </h3>
                <button id="closeTodayLeaveModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div id="todayLeaveContent" class="space-y-4">
                <!-- Content will be loaded here -->
            </div>
            
            <div id="todayLeaveEmpty" class="hidden text-center py-12">
                <div class="text-6xl mb-4">😊</div>
                <h4 class="text-xl font-semibold text-gray-700 mb-2">Tidak Ada Pegawai Cuti Hari Ini</h4>
                <p class="text-gray-500">Semua pegawai hadir bekerja hari ini</p>
            </div>
            
            <div id="todayLeaveLoading" class="text-center py-12">
                <div class="loading mx-auto mb-4"></div>
                <p class="text-gray-600">Memuat data cuti hari ini...</p>
            </div>
            
            <div id="todayLeaveError" class="hidden text-center py-12">
                <div class="text-6xl mb-4">⚠️</div>
                <h4 class="text-xl font-semibold text-red-600 mb-2">Gagal Memuat Data</h4>
                <p class="text-gray-500 mb-4">Tidak dapat mengakses data dari Google Spreadsheet</p>
                <button onclick="loadTodayLeaveData()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    🔄 Coba Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Detail Modal -->
    <div id="employeeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 slide-down max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="detailEmployeeName">Detail Cuti Pegawai</h3>
                <button id="closeDetailModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cuti Tahunan -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Cuti Tahunan</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-blue-600 cursor-pointer hover:text-blue-800" id="cutiTahunan" onclick="toggleNarasi('tahunan')">0</span>
                        <div id="editCutiTahunan" class="hidden">
                            <input type="number" class="w-20 px-2 py-1 border rounded" min="0" max="12">
                            <button class="ml-2 bg-blue-600 text-white px-2 py-1 rounded text-sm" onclick="saveCuti('tahunan')">Simpan</button>
                        </div>
                        <button id="btnEditTahunan" class="admin-only hidden bg-blue-600 text-white px-3 py-1 rounded text-sm" onclick="editCuti('tahunan')">Edit</button>
                    </div>
                    <p class="text-sm text-gray-600 cursor-pointer hover:text-gray-800" onclick="toggleNarasi('tahunan')">hari terpakai (klik untuk detail)</p>
                    <div id="narasiTahunan" class="hidden mt-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-blue-800">Keterangan Cuti Tahunan:</h5>
                            <button id="btnEditNarasiTahunan" class="admin-only hidden text-blue-600 text-sm hover:text-blue-800" onclick="editNarasi('tahunan')">✏️ Edit</button>
                        </div>
                        <p id="textNarasiTahunan" class="text-sm text-gray-700">-</p>
                        <div id="editTextNarasiTahunan" class="hidden mt-2">
                            <textarea class="w-full p-2 border rounded text-sm" rows="3" placeholder="Masukkan keterangan cuti..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm" onclick="saveNarasi('tahunan')">Simpan</button>
                                <button class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="cancelEditNarasi('tahunan')">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuti Besar -->
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-2">Cuti Besar</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-green-600 cursor-pointer hover:text-green-800" id="cutiBesar" onclick="toggleNarasi('besar')">0</span>
                        <div id="editCutiBesar" class="hidden">
                            <input type="number" class="w-20 px-2 py-1 border rounded" min="0">
                            <button class="ml-2 bg-green-600 text-white px-2 py-1 rounded text-sm" onclick="saveCuti('besar')">Simpan</button>
                        </div>
                        <button id="btnEditBesar" class="admin-only hidden bg-green-600 text-white px-3 py-1 rounded text-sm" onclick="editCuti('besar')">Edit</button>
                    </div>
                    <p class="text-sm text-gray-600 cursor-pointer hover:text-gray-800" onclick="toggleNarasi('besar')">hari terpakai (klik untuk detail)</p>
                    <div id="narasiBesar" class="hidden mt-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-green-800">Keterangan Cuti Besar:</h5>
                            <button id="btnEditNarasiBesar" class="admin-only hidden text-green-600 text-sm hover:text-green-800" onclick="editNarasi('besar')">✏️ Edit</button>
                        </div>
                        <p id="textNarasiBesar" class="text-sm text-gray-700">-</p>
                        <div id="editTextNarasiBesar" class="hidden mt-2">
                            <textarea class="w-full p-2 border rounded text-sm" rows="3" placeholder="Masukkan keterangan cuti..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-green-600 text-white px-3 py-1 rounded text-sm" onclick="saveNarasi('besar')">Simpan</button>
                                <button class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="cancelEditNarasi('besar')">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuti Alasan Penting -->
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-yellow-800 mb-2">Cuti Alasan Penting</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-yellow-600 cursor-pointer hover:text-yellow-800" id="cutiPenting" onclick="toggleNarasi('penting')">0</span>
                        <div id="editCutiPenting" class="hidden">
                            <input type="number" class="w-20 px-2 py-1 border rounded" min="0">
                            <button class="ml-2 bg-yellow-600 text-white px-2 py-1 rounded text-sm" onclick="saveCuti('penting')">Simpan</button>
                        </div>
                        <button id="btnEditPenting" class="admin-only hidden bg-yellow-600 text-white px-3 py-1 rounded text-sm" onclick="editCuti('penting')">Edit</button>
                    </div>
                    <p class="text-sm text-gray-600 cursor-pointer hover:text-gray-800" onclick="toggleNarasi('penting')">hari terpakai (klik untuk detail)</p>
                    <div id="narasiPenting" class="hidden mt-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-yellow-800">Keterangan Cuti Alasan Penting:</h5>
                            <button id="btnEditNarasiPenting" class="admin-only hidden text-yellow-600 text-sm hover:text-yellow-800" onclick="editNarasi('penting')">✏️ Edit</button>
                        </div>
                        <p id="textNarasiPenting" class="text-sm text-gray-700">-</p>
                        <div id="editTextNarasiPenting" class="hidden mt-2">
                            <textarea class="w-full p-2 border rounded text-sm" rows="3" placeholder="Masukkan keterangan cuti..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-yellow-600 text-white px-3 py-1 rounded text-sm" onclick="saveNarasi('penting')">Simpan</button>
                                <button class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="cancelEditNarasi('penting')">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuti Sakit -->
                <div class="bg-red-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-red-800 mb-2">Cuti Sakit</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-red-600 cursor-pointer hover:text-red-800" id="cutiSakit" onclick="toggleNarasi('sakit')">0</span>
                        <div id="editCutiSakit" class="hidden">
                            <input type="number" class="w-20 px-2 py-1 border rounded" min="0">
                            <button class="ml-2 bg-red-600 text-white px-2 py-1 rounded text-sm" onclick="saveCuti('sakit')">Simpan</button>
                        </div>
                        <button id="btnEditSakit" class="admin-only hidden bg-red-600 text-white px-3 py-1 rounded text-sm" onclick="editCuti('sakit')">Edit</button>
                    </div>
                    <p class="text-sm text-gray-600 cursor-pointer hover:text-gray-800" onclick="toggleNarasi('sakit')">hari terpakai (klik untuk detail)</p>
                    <div id="narasiSakit" class="hidden mt-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-red-800">Keterangan Cuti Sakit:</h5>
                            <button id="btnEditNarasiSakit" class="admin-only hidden text-red-600 text-sm hover:text-red-800" onclick="editNarasi('sakit')">✏️ Edit</button>
                        </div>
                        <p id="textNarasiSakit" class="text-sm text-gray-700">-</p>
                        <div id="editTextNarasiSakit" class="hidden mt-2">
                            <textarea class="w-full p-2 border rounded text-sm" rows="3" placeholder="Masukkan keterangan cuti..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-red-600 text-white px-3 py-1 rounded text-sm" onclick="saveNarasi('sakit')">Simpan</button>
                                <button class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="cancelEditNarasi('sakit')">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuti Melahirkan -->
                <div class="bg-pink-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-pink-800 mb-2">Cuti Melahirkan</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-pink-600 cursor-pointer hover:text-pink-800" id="cutiMelahirkan" onclick="toggleNarasi('melahirkan')">0</span>
                        <div id="editCutiMelahirkan" class="hidden">
                            <input type="number" class="w-20 px-2 py-1 border rounded" min="0">
                            <button class="ml-2 bg-pink-600 text-white px-2 py-1 rounded text-sm" onclick="saveCuti('melahirkan')">Simpan</button>
                        </div>
                        <button id="btnEditMelahirkan" class="admin-only hidden bg-pink-600 text-white px-3 py-1 rounded text-sm" onclick="editCuti('melahirkan')">Edit</button>
                    </div>
                    <p class="text-sm text-gray-600 cursor-pointer hover:text-gray-800" onclick="toggleNarasi('melahirkan')">hari terpakai (klik untuk detail)</p>
                    <div id="narasiMelahirkan" class="hidden mt-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-pink-800">Keterangan Cuti Melahirkan:</h5>
                            <button id="btnEditNarasiMelahirkan" class="admin-only hidden text-pink-600 text-sm hover:text-pink-800" onclick="editNarasi('melahirkan')">✏️ Edit</button>
                        </div>
                        <p id="textNarasiMelahirkan" class="text-sm text-gray-700">-</p>
                        <div id="editTextNarasiMelahirkan" class="hidden mt-2">
                            <textarea class="w-full p-2 border rounded text-sm" rows="3" placeholder="Masukkan keterangan cuti..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-pink-600 text-white px-3 py-1 rounded text-sm" onclick="saveNarasi('melahirkan')">Simpan</button>
                                <button class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="cancelEditNarasi('melahirkan')">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuti Diluar Tanggungan Negara -->
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-purple-800 mb-2">Cuti Diluar Tanggungan Negara</h4>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-purple-600 cursor-pointer hover:text-purple-800" id="cutiDiluar" onclick="toggleNarasi('diluar')">0</span>
                        <div id="editCutiDiluar" class="hidden">
                            <input type="number" class="w-20 px-2 py-1 border rounded" min="0">
                            <button class="ml-2 bg-purple-600 text-white px-2 py-1 rounded text-sm" onclick="saveCuti('diluar')">Simpan</button>
                        </div>
                        <button id="btnEditDiluar" class="admin-only hidden bg-purple-600 text-white px-3 py-1 rounded text-sm" onclick="editCuti('diluar')">Edit</button>
                    </div>
                    <p class="text-sm text-gray-600 cursor-pointer hover:text-gray-800" onclick="toggleNarasi('diluar')">hari terpakai (klik untuk detail)</p>
                    <div id="narasiDiluar" class="hidden mt-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-medium text-purple-800">Keterangan Cuti Diluar Tanggungan Negara:</h5>
                            <button id="btnEditNarasiDiluar" class="admin-only hidden text-purple-600 text-sm hover:text-purple-800" onclick="editNarasi('diluar')">✏️ Edit</button>
                        </div>
                        <p id="textNarasiDiluar" class="text-sm text-gray-700">-</p>
                        <div id="editTextNarasiDiluar" class="hidden mt-2">
                            <textarea class="w-full p-2 border rounded text-sm" rows="3" placeholder="Masukkan keterangan cuti..."></textarea>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-purple-600 text-white px-3 py-1 rounded text-sm" onclick="saveNarasi('diluar')">Simpan</button>
                                <button class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm" onclick="cancelEditNarasi('diluar')">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isAdminMode = false;
        let currentEmployeeId = null;
        let employees = [];
        let filteredEmployees = [];
        let unsubscribeEmployees = null;
        let searchQuery = '';
        let todayLeaveData = [];
        let todayLeaveCount = 0;

        // Firebase functions
        async function initializeFirebase() {
            try {
                showLoading();
                
                // Listen to real-time updates
                const employeesRef = window.firestore.collection(window.db, 'employees');
                unsubscribeEmployees = window.firestore.onSnapshot(employeesRef, (snapshot) => {
                    employees = [];
                    snapshot.forEach((doc) => {
                        employees.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderEmployees();
                    updateStatistics();
                    hideLoading();
                    updateConnectionStatus(true);
                }, (error) => {
                    console.error('Error listening to employees:', error);
                    updateConnectionStatus(false);
                    hideLoading();
                    
                    // Load sample data if Firebase fails
                    if (employees.length === 0) {
                        loadSampleData();
                    }
                });

            } catch (error) {
                console.error('Error initializing Firebase:', error);
                updateConnectionStatus(false);
                hideLoading();
                loadSampleData();
            }
        }

        // Load sample data as fallback
        function loadSampleData() {
            employees = [
                {
                    id: 'sample1',
                    name: "Drs. Ahmad Syahputra",
                    nip: "196501011990031001",
                    position: "Kepala Stasiun",
                    cuti: {
                        tahunan: 8,
                        besar: 0,
                        penting: 2,
                        sakit: 1,
                        melahirkan: 0,
                        diluar: 0
                    },
                    narasi: {
                        tahunan: "Cuti tahunan digunakan untuk liburan keluarga dan istirahat.",
                        besar: "",
                        penting: "Menghadiri acara keluarga yang mendesak.",
                        sakit: "Sakit demam dan flu.",
                        melahirkan: "",
                        diluar: ""
                    },
                    photo: null
                },
                {
                    id: 'sample2',
                    name: "Siti Nurhaliza, S.Sos",
                    nip: "197203151995032001",
                    position: "Penyiar Senior",
                    cuti: {
                        tahunan: 10,
                        besar: 0,
                        penting: 1,
                        sakit: 3,
                        melahirkan: 90,
                        diluar: 0
                    },
                    narasi: {
                        tahunan: "Cuti tahunan untuk refreshing dan quality time bersama keluarga.",
                        besar: "",
                        penting: "Mengurus dokumen penting di kantor kelurahan.",
                        sakit: "Sakit maag dan perlu istirahat total.",
                        melahirkan: "Cuti melahirkan anak kedua, proses persalinan normal dan pemulihan.",
                        diluar: ""
                    },
                    photo: null
                },
                {
                    id: 'sample3',
                    name: "Budi Santoso, S.T",
                    nip: "198506102010121001",
                    position: "Teknisi Pemancar",
                    cuti: {
                        tahunan: 6,
                        besar: 0,
                        penting: 0,
                        sakit: 2,
                        melahirkan: 0,
                        diluar: 0
                    },
                    narasi: {
                        tahunan: "Cuti tahunan untuk mudik lebaran dan berkumpul dengan keluarga besar.",
                        besar: "",
                        penting: "",
                        sakit: "Sakit punggung akibat kerja lembur dan perlu fisioterapi.",
                        melahirkan: "",
                        diluar: ""
                    },
                    photo: null
                }
            ];
            renderEmployees();
            updateStatistics();
        }

        // Show/hide loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            // Connection status display removed - function kept for compatibility
            console.log(connected ? 'Firebase connected' : 'Firebase offline');
        }

        // Firebase CRUD operations
        async function addEmployeeToFirebase(employeeData) {
            try {
                showLoading();
                const docRef = await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'employees'),
                    employeeData
                );
                console.log('Employee added with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error adding employee:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        async function updateEmployeeInFirebase(employeeId, updateData) {
            try {
                showLoading();
                const employeeRef = window.firestore.doc(window.db, 'employees', employeeId);
                await window.firestore.updateDoc(employeeRef, updateData);
                console.log('Employee updated:', employeeId);
            } catch (error) {
                console.error('Error updating employee:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        async function deleteEmployeeFromFirebase(employeeId) {
            try {
                showLoading();
                const employeeRef = window.firestore.doc(window.db, 'employees', employeeId);
                await window.firestore.deleteDoc(employeeRef);
                console.log('Employee deleted:', employeeId);
            } catch (error) {
                console.error('Error deleting employee:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Google Spreadsheet integration
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwN6hYp0m2Q6gQLtuYDN6sWCPBv_u62FgEUvYrWpINdfvZMWmRqizQMF-O9yjx_bFr8nAzG0z2SSlr/pub?gid=574165242&single=true&output=csv';

        // Load today's leave data from Google Spreadsheet
        async function loadTodayLeaveData() {
            try {
                showTodayLeaveLoading();
                
                const response = await fetch(SPREADSHEET_URL);
                if (!response.ok) {
                    throw new Error('Gagal mengakses spreadsheet');
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                // Process the data
                const today = new Date();
                const todayStr = formatDateForComparison(today);
                
                todayLeaveData = [];
                
                // Skip header row and process data
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 6) continue; // Skip incomplete rows
                    
                    const nama = row[1]?.trim();
                    const jenisKelamin = row[2]?.trim();
                    const jenisIzin = row[3]?.trim();
                    const tanggalMulai = row[4]?.trim();
                    const tanggalSelesai = row[5]?.trim();
                    const keterangan = row[6]?.trim() || '';
                    
                    if (!nama || !tanggalMulai || !tanggalSelesai) continue;
                    
                    // Parse dates
                    const startDate = parseSpreadsheetDate(tanggalMulai);
                    const endDate = parseSpreadsheetDate(tanggalSelesai);
                    
                    if (!startDate || !endDate) continue;
                    
                    // Check if today is within the leave period
                    if (today >= startDate && today <= endDate) {
                        todayLeaveData.push({
                            nama: nama,
                            jenisKelamin: jenisKelamin,
                            jenisIzin: jenisIzin,
                            tanggalMulai: formatDateDisplay(startDate),
                            tanggalSelesai: formatDateDisplay(endDate),
                            keterangan: keterangan,
                            durasi: calculateLeaveDuration(startDate, endDate)
                        });
                    }
                }
                
                todayLeaveCount = todayLeaveData.length;
                updateTodayLeaveDisplay();
                hideTodayLeaveLoading();
                
            } catch (error) {
                console.error('Error loading today leave data:', error);
                showTodayLeaveError();
                hideTodayLeaveLoading();
            }
        }

        // Parse CSV text into array of arrays
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                if (line.trim() === '') continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        // Parse date from spreadsheet (handles various formats)
        function parseSpreadsheetDate(dateStr) {
            if (!dateStr) return null;
            
            // Remove quotes if present
            dateStr = dateStr.replace(/"/g, '').trim();
            
            // Try different date formats
            const formats = [
                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, // MM/DD/YYYY or DD/MM/YYYY
                /^(\d{4})-(\d{1,2})-(\d{1,2})$/, // YYYY-MM-DD
                /^(\d{1,2})-(\d{1,2})-(\d{4})$/, // DD-MM-YYYY
            ];
            
            for (let format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    let day, month, year;
                    
                    if (format === formats[1]) { // YYYY-MM-DD
                        year = parseInt(match[1]);
                        month = parseInt(match[2]) - 1; // Month is 0-indexed
                        day = parseInt(match[3]);
                    } else { // Assume DD/MM/YYYY or DD-MM-YYYY
                        day = parseInt(match[1]);
                        month = parseInt(match[2]) - 1; // Month is 0-indexed
                        year = parseInt(match[3]);
                    }
                    
                    const date = new Date(year, month, day);
                    
                    // Validate the date
                    if (date.getFullYear() === year && 
                        date.getMonth() === month && 
                        date.getDate() === day) {
                        return date;
                    }
                }
            }
            
            // Try native Date parsing as fallback
            const fallbackDate = new Date(dateStr);
            if (!isNaN(fallbackDate.getTime())) {
                return fallbackDate;
            }
            
            return null;
        }

        // Format date for comparison (YYYY-MM-DD)
        function formatDateForComparison(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }

        // Format date for display (DD/MM/YYYY)
        function formatDateDisplay(date) {
            return String(date.getDate()).padStart(2, '0') + '/' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                   date.getFullYear();
        }

        // Calculate leave duration in days
        function calculateLeaveDuration(startDate, endDate) {
            const timeDiff = endDate.getTime() - startDate.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates
            return dayDiff;
        }

        // Check if text contains URL or link
        function isLinkOrUrl(text) {
            if (!text) return false;
            
            const lowerText = text.toLowerCase();
            
            // Check for common URL patterns
            const urlPatterns = [
                /https?:\/\//i,
                /www\./i,
                /\.com/i,
                /\.co\.id/i,
                /\.org/i,
                /\.net/i,
                /drive\.google/i,
                /docs\.google/i,
                /forms\.gle/i
            ];
            
            // Check for link-related keywords
            const linkKeywords = [
                'link',
                'url',
                'drive',
                'google drive',
                'google docs',
                'google form',
                'dropbox',
                'onedrive'
            ];
            
            // Test URL patterns
            for (let pattern of urlPatterns) {
                if (pattern.test(text)) {
                    return true;
                }
            }
            
            // Test link keywords
            for (let keyword of linkKeywords) {
                if (lowerText.includes(keyword)) {
                    return true;
                }
            }
            
            return false;
        }

        // Show today's leave modal
        function showTodayLeaveModal() {
            document.getElementById('todayLeaveModal').classList.remove('hidden');
            document.getElementById('todayLeaveModal').classList.add('flex');
            
            // Set today's date display
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('todayDateDisplay').textContent = today.toLocaleDateString('id-ID', options);
            
            // Load data if not already loaded
            if (todayLeaveData.length === 0 && todayLeaveCount === 0) {
                loadTodayLeaveData();
            } else {
                updateTodayLeaveDisplay();
            }
        }

        // Hide today's leave modal
        function hideTodayLeaveModal() {
            document.getElementById('todayLeaveModal').classList.add('hidden');
            document.getElementById('todayLeaveModal').classList.remove('flex');
        }

        // Update today's leave display
        function updateTodayLeaveDisplay() {
            const content = document.getElementById('todayLeaveContent');
            const empty = document.getElementById('todayLeaveEmpty');
            
            if (todayLeaveData.length === 0) {
                content.classList.add('hidden');
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                content.classList.remove('hidden');
                
                content.innerHTML = '';
                
                todayLeaveData.forEach((leave, index) => {
                    const leaveCard = document.createElement('div');
                    leaveCard.className = 'bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-6 border border-orange-200 shadow-lg hover:shadow-xl transition-all duration-300 fade-in';
                    leaveCard.style.animationDelay = `${index * 0.1}s`;
                    
                    const genderIcon = leave.jenisKelamin?.toLowerCase().includes('perempuan') || leave.jenisKelamin?.toLowerCase().includes('wanita') ? '👩' : '👨';
                    
                    leaveCard.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-yellow-500 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-lg">
                                    ${genderIcon}
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-xl font-bold text-gray-800 mb-1">${leave.nama}</h4>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                                            ${leave.jenisIzin}
                                        </span>
                                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                            ${leave.durasi} hari
                                        </span>
                                    </div>
                                    <div class="space-y-2 text-sm text-gray-600">
                                        <div class="flex items-center">
                                            <span class="w-20 font-medium">Mulai:</span>
                                            <span>${leave.tanggalMulai}</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-20 font-medium">Selesai:</span>
                                            <span>${leave.tanggalSelesai}</span>
                                        </div>
                                        ${leave.keterangan && !isLinkOrUrl(leave.keterangan) ? `
                                            <div class="flex items-start">
                                                <span class="w-20 font-medium">Keterangan:</span>
                                                <span class="flex-1">${leave.keterangan}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    content.appendChild(leaveCard);
                });
            }
            
            // Update counter in statistics card
            document.getElementById('todayLeaveCount').textContent = todayLeaveCount;
        }

        // Show/hide loading states
        function showTodayLeaveLoading() {
            document.getElementById('todayLeaveLoading').classList.remove('hidden');
            document.getElementById('todayLeaveContent').classList.add('hidden');
            document.getElementById('todayLeaveEmpty').classList.add('hidden');
            document.getElementById('todayLeaveError').classList.add('hidden');
        }

        function hideTodayLeaveLoading() {
            document.getElementById('todayLeaveLoading').classList.add('hidden');
        }

        function showTodayLeaveError() {
            document.getElementById('todayLeaveError').classList.remove('hidden');
            document.getElementById('todayLeaveContent').classList.add('hidden');
            document.getElementById('todayLeaveEmpty').classList.add('hidden');
        }

        // Initialize the application
        function init() {
            setupEventListeners();
            initializeFirebase();
            loadTodayLeaveData(); // Load today's leave data on startup
        }

        // Update statistics
        function updateStatistics() {
            // Total Pegawai
            document.getElementById('totalEmployees').textContent = employees.length;

            // Calculate total leaves and most used leave type
            const leaveTypes = {
                'Cuti Tahunan': 0,
                'Cuti Besar': 0,
                'Cuti Alasan Penting': 0,
                'Cuti Sakit': 0,
                'Cuti Melahirkan': 0,
                'Cuti Diluar Tanggungan Negara': 0
            };

            let totalAllLeaves = 0;

            employees.forEach(employee => {
                if (employee.cuti) {
                    leaveTypes['Cuti Tahunan'] += employee.cuti.tahunan || 0;
                    leaveTypes['Cuti Besar'] += employee.cuti.besar || 0;
                    leaveTypes['Cuti Alasan Penting'] += employee.cuti.penting || 0;
                    leaveTypes['Cuti Sakit'] += employee.cuti.sakit || 0;
                    leaveTypes['Cuti Melahirkan'] += employee.cuti.melahirkan || 0;
                    leaveTypes['Cuti Diluar Tanggungan Negara'] += employee.cuti.diluar || 0;

                    totalAllLeaves += Object.values(employee.cuti).reduce((sum, val) => sum + (val || 0), 0);
                }
            });

            // Find most used leave type
            let mostUsedType = 'Tidak ada data';
            let mostUsedCount = 0;

            for (const [type, count] of Object.entries(leaveTypes)) {
                if (count > mostUsedCount) {
                    mostUsedCount = count;
                    mostUsedType = type;
                }
            }

            // Update display
            document.getElementById('totalAllLeaves').textContent = totalAllLeaves;
            document.getElementById('mostUsedLeaveType').textContent = mostUsedType;
            document.getElementById('mostUsedLeaveCount').textContent = `${mostUsedCount} hari`;
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('cancelLogin').addEventListener('click', hideLoginModal);
            document.getElementById('addEmployeeBtn').addEventListener('click', showAddEmployeeModal);
            document.getElementById('addEmployeeForm').addEventListener('submit', handleAddEmployee);
            document.getElementById('cancelAddEmployee').addEventListener('click', hideAddEmployeeModal);
            document.getElementById('closeDetailModal').addEventListener('click', hideEmployeeDetailModal);
            document.getElementById('closeTodayLeaveModal').addEventListener('click', hideTodayLeaveModal);
            document.getElementById('editEmployeeForm').addEventListener('submit', handleEditEmployee);
            document.getElementById('cancelEditEmployee').addEventListener('click', hideEditEmployeeModal);
            document.getElementById('photoInput').addEventListener('change', handlePhotoSelect);
            document.getElementById('cancelPhotoUpload').addEventListener('click', hidePhotoUploadModal);
            document.getElementById('savePhoto').addEventListener('click', handleSavePhoto);
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            
            setupPhotoEditor();
        }

        // Render employee cards
        function renderEmployees() {
            const grid = document.getElementById('employeeGrid');
            grid.innerHTML = '';

            employees.forEach(employee => {
                const totalCuti = employee.cuti ? Object.values(employee.cuti).reduce((sum, val) => sum + (val || 0), 0) : 0;
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 fade-in';
                card.onclick = () => showEmployeeDetail(employee.id);
                
                card.innerHTML = `
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <div class="flex items-center justify-center border-4 border-white shadow-lg mx-auto mb-3" style="width: 96px; height: 96px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, #3b82f6, #8b5cf6);">
                                ${employee.photo ? 
                                    `<img src="${employee.photo}" alt="${employee.name}" style="width: 100%; height: 100%; object-fit: cover; object-position: center; border-radius: 50%;">` :
                                    `<span class="text-white font-bold text-2xl">${employee.name.split(' ').map(n => n[0]).join('').substring(0, 2)}</span>`
                                }
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">${employee.name}</h3>
                            <p class="text-sm text-gray-600 mb-1">${employee.position}</p>
                            <p class="text-xs text-gray-500">NIP: ${employee.nip}</p>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Cuti Terpakai:</span>
                                <span class="text-2xl font-bold text-red-600">${totalCuti}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">hari</p>
                        </div>
                        ${isAdminMode ? `
                            <div class="mt-4 pt-4 border-t space-y-2">
                                <button onclick="event.stopPropagation(); editEmployee('${employee.id}')" 
                                        class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 py-2 px-4 rounded-lg text-sm font-medium transition-colors">
                                    ✏️ Edit Data
                                </button>
                                <button onclick="event.stopPropagation(); uploadPhoto('${employee.id}')" 
                                        class="w-full bg-green-100 hover:bg-green-200 text-green-700 py-2 px-4 rounded-lg text-sm font-medium transition-colors">
                                    📷 Upload Foto
                                </button>
                                <button onclick="event.stopPropagation(); deleteEmployee('${employee.id}')" 
                                        class="w-full bg-red-100 hover:bg-red-200 text-red-700 py-2 px-4 rounded-lg text-sm font-medium transition-colors">
                                    🗑️ Hapus Pegawai
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
        }

        // Hide login modal
        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
            document.getElementById('loginForm').reset();
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Simple authentication (in real app, this would be server-side)
            if (username === 'priadipasaribu@gmail.com' && password === 'rriadmin2025') {
                isAdminMode = true;
                updateUIMode();
                hideLoginModal();
                alert('Login berhasil! Sekarang Anda dalam mode admin.');
            } else {
                alert('Username atau password salah!');
            }
        }

        // Logout
        function logout() {
            isAdminMode = false;
            updateUIMode();
            alert('Logout berhasil! Kembali ke mode pengguna.');
        }

        // Update UI based on mode
        function updateUIMode() {
            const modeIndicator = document.getElementById('modeIndicator');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminControls = document.getElementById('adminControls');

            if (isAdminMode) {
                modeIndicator.textContent = 'Mode: Admin';
                modeIndicator.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                adminControls.classList.remove('hidden');
                // Adjust grid layout when admin panel is visible
                adminControls.parentElement.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8';
            } else {
                modeIndicator.textContent = 'Mode: Pengguna';
                modeIndicator.className = 'px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                adminControls.classList.add('hidden');
                // Adjust grid layout when admin panel is hidden
                adminControls.parentElement.className = 'grid grid-cols-1 gap-6 mb-8';
            }

            renderEmployees();
        }

        // Show add employee modal
        function showAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.remove('hidden');
            document.getElementById('addEmployeeModal').classList.add('flex');
        }

        // Hide add employee modal
        function hideAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.add('hidden');
            document.getElementById('addEmployeeModal').classList.remove('flex');
            document.getElementById('addEmployeeForm').reset();
        }

        // Handle add employee
        async function handleAddEmployee(e) {
            e.preventDefault();
            const name = document.getElementById('employeeName').value;
            const nip = document.getElementById('employeeNIP').value;
            const position = document.getElementById('employeePosition').value;

            const newEmployee = {
                name: name,
                nip: nip,
                position: position,
                cuti: {
                    tahunan: 0,
                    besar: 0,
                    penting: 0,
                    sakit: 0,
                    melahirkan: 0,
                    diluar: 0
                },
                narasi: {
                    tahunan: "",
                    besar: "",
                    penting: "",
                    sakit: "",
                    melahirkan: "",
                    diluar: ""
                },
                photo: null,
                createdAt: new Date().toISOString()
            };

            try {
                document.getElementById('addEmployeeSpinner').classList.remove('hidden');
                await addEmployeeToFirebase(newEmployee);
                hideAddEmployeeModal();
                alert('Pegawai berhasil ditambahkan!');
            } catch (error) {
                alert('Gagal menambahkan pegawai: ' + error.message);
            } finally {
                document.getElementById('addEmployeeSpinner').classList.add('hidden');
            }
        }

        // Edit employee
        function editEmployee(id) {
            currentEmployeeId = id;
            const employee = employees.find(emp => emp.id === id);
            
            document.getElementById('editEmployeeName').value = employee.name;
            document.getElementById('editEmployeeNIP').value = employee.nip;
            document.getElementById('editEmployeePosition').value = employee.position;
            
            showEditEmployeeModal();
        }

        // Show edit employee modal
        function showEditEmployeeModal() {
            document.getElementById('editEmployeeModal').classList.remove('hidden');
            document.getElementById('editEmployeeModal').classList.add('flex');
        }

        // Hide edit employee modal
        function hideEditEmployeeModal() {
            document.getElementById('editEmployeeModal').classList.add('hidden');
            document.getElementById('editEmployeeModal').classList.remove('flex');
            document.getElementById('editEmployeeForm').reset();
            currentEmployeeId = null;
        }

        // Handle edit employee
        async function handleEditEmployee(e) {
            e.preventDefault();
            const name = document.getElementById('editEmployeeName').value;
            const nip = document.getElementById('editEmployeeNIP').value;
            const position = document.getElementById('editEmployeePosition').value;

            const updateData = {
                name: name,
                nip: nip,
                position: position,
                updatedAt: new Date().toISOString()
            };

            try {
                document.getElementById('editEmployeeSpinner').classList.remove('hidden');
                await updateEmployeeInFirebase(currentEmployeeId, updateData);
                hideEditEmployeeModal();
                alert('Data pegawai berhasil diperbarui!');
            } catch (error) {
                alert('Gagal memperbarui data pegawai: ' + error.message);
            } finally {
                document.getElementById('editEmployeeSpinner').classList.add('hidden');
            }
        }

        // Delete employee
        async function deleteEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            const employeeName = employee ? employee.name : 'pegawai ini';
            
            if (confirm(`Apakah Anda yakin ingin menghapus ${employeeName}?\n\nData yang akan dihapus:\n- Data pribadi pegawai\n- Semua data cuti\n- Foto pegawai\n\nTindakan ini tidak dapat dibatalkan!`)) {
                try {
                    showLoading();
                    
                    // Check if this is a sample employee (offline mode)
                    if (id.startsWith('sample')) {
                        // Remove from local array for sample data
                        const index = employees.findIndex(emp => emp.id === id);
                        if (index > -1) {
                            employees.splice(index, 1);
                            renderEmployees();
                            updateStatistics();
                            hideLoading();
                            alert('Pegawai berhasil dihapus!');
                        } else {
                            hideLoading();
                            alert('Pegawai tidak ditemukan!');
                        }
                    } else {
                        // Delete from Firebase
                        try {
                            await deleteEmployeeFromFirebase(id);
                            hideLoading();
                            alert('Pegawai berhasil dihapus!');
                        } catch (firebaseError) {
                            console.error('Firebase delete error:', firebaseError);
                            // If Firebase fails, try to remove from local array as fallback
                            const index = employees.findIndex(emp => emp.id === id);
                            if (index > -1) {
                                employees.splice(index, 1);
                                renderEmployees();
                                updateStatistics();
                                hideLoading();
                                alert('Pegawai berhasil dihapus (mode offline)!');
                            } else {
                                hideLoading();
                                throw firebaseError;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    hideLoading();
                    alert('Gagal menghapus pegawai: ' + error.message);
                }
            }
        }

        // Show employee detail
        function showEmployeeDetail(id) {
            currentEmployeeId = id;
            const employee = employees.find(emp => emp.id === id);
            
            document.getElementById('detailEmployeeName').textContent = `Detail Cuti - ${employee.name}`;
            
            // Load cuti data with fallback
            const cuti = employee.cuti || {};
            document.getElementById('cutiTahunan').textContent = cuti.tahunan || 0;
            document.getElementById('cutiBesar').textContent = cuti.besar || 0;
            document.getElementById('cutiPenting').textContent = cuti.penting || 0;
            document.getElementById('cutiSakit').textContent = cuti.sakit || 0;
            document.getElementById('cutiMelahirkan').textContent = cuti.melahirkan || 0;
            document.getElementById('cutiDiluar').textContent = cuti.diluar || 0;

            // Load narasi text with fallback
            const narasi = employee.narasi || {};
            document.getElementById('textNarasiTahunan').textContent = narasi.tahunan || '-';
            document.getElementById('textNarasiBesar').textContent = narasi.besar || '-';
            document.getElementById('textNarasiPenting').textContent = narasi.penting || '-';
            document.getElementById('textNarasiSakit').textContent = narasi.sakit || '-';
            document.getElementById('textNarasiMelahirkan').textContent = narasi.melahirkan || '-';
            document.getElementById('textNarasiDiluar').textContent = narasi.diluar || '-';

            // Show/hide admin controls
            const adminButtons = document.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                if (isAdminMode) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });

            document.getElementById('employeeDetailModal').classList.remove('hidden');
            document.getElementById('employeeDetailModal').classList.add('flex');
        }

        // Hide employee detail modal
        function hideEmployeeDetailModal() {
            document.getElementById('employeeDetailModal').classList.add('hidden');
            document.getElementById('employeeDetailModal').classList.remove('flex');
            currentEmployeeId = null;
        }

        // Edit cuti
        function editCuti(type) {
            const displayElement = document.getElementById(`cuti${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const editElement = document.getElementById(`editCuti${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const btnElement = document.getElementById(`btnEdit${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            const currentValue = parseInt(displayElement.textContent);
            editElement.querySelector('input').value = currentValue;
            
            displayElement.classList.add('hidden');
            btnElement.classList.add('hidden');
            editElement.classList.remove('hidden');
        }

        // Save cuti
        async function saveCuti(type) {
            const editElement = document.getElementById(`editCuti${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const displayElement = document.getElementById(`cuti${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const btnElement = document.getElementById(`btnEdit${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            const newValue = parseInt(editElement.querySelector('input').value) || 0;
            
            try {
                // Update Firebase
                const employee = employees.find(emp => emp.id === currentEmployeeId);
                const updatedCuti = { ...employee.cuti };
                updatedCuti[type] = newValue;
                
                await updateEmployeeInFirebase(currentEmployeeId, {
                    cuti: updatedCuti,
                    updatedAt: new Date().toISOString()
                });
                
                // Update display
                displayElement.textContent = newValue;
                displayElement.classList.remove('hidden');
                btnElement.classList.remove('hidden');
                editElement.classList.add('hidden');
                
                alert('Data cuti berhasil diperbarui!');
            } catch (error) {
                alert('Gagal memperbarui data cuti: ' + error.message);
            }
        }

        // Toggle narasi visibility
        function toggleNarasi(type) {
            const narasiElement = document.getElementById(`narasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            narasiElement.classList.toggle('hidden');
        }

        // Edit narasi
        function editNarasi(type) {
            const employee = employees.find(emp => emp.id === currentEmployeeId);
            const textElement = document.getElementById(`textNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const editElement = document.getElementById(`editTextNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const btnElement = document.getElementById(`btnEditNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            const currentText = employee.narasi && employee.narasi[type] ? employee.narasi[type] : '';
            editElement.querySelector('textarea').value = currentText;
            
            textElement.classList.add('hidden');
            btnElement.classList.add('hidden');
            editElement.classList.remove('hidden');
        }

        // Save narasi
        async function saveNarasi(type) {
            const editElement = document.getElementById(`editTextNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const textElement = document.getElementById(`textNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const btnElement = document.getElementById(`btnEditNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            const newText = editElement.querySelector('textarea').value.trim();
            
            try {
                // Update Firebase
                const employee = employees.find(emp => emp.id === currentEmployeeId);
                const updatedNarasi = { ...employee.narasi };
                updatedNarasi[type] = newText;
                
                await updateEmployeeInFirebase(currentEmployeeId, {
                    narasi: updatedNarasi,
                    updatedAt: new Date().toISOString()
                });
                
                // Update display
                textElement.textContent = newText || '-';
                textElement.classList.remove('hidden');
                btnElement.classList.remove('hidden');
                editElement.classList.add('hidden');
                
                alert('Keterangan cuti berhasil diperbarui!');
            } catch (error) {
                alert('Gagal memperbarui keterangan cuti: ' + error.message);
            }
        }

        // Cancel edit narasi
        function cancelEditNarasi(type) {
            const textElement = document.getElementById(`textNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const editElement = document.getElementById(`editTextNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const btnElement = document.getElementById(`btnEditNarasi${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            textElement.classList.remove('hidden');
            btnElement.classList.remove('hidden');
            editElement.classList.add('hidden');
        }

        // Ajukan Cuti - redirect to Google Form
        function ajukanCuti() {
            // Replace this URL with your actual Google Form URL
            const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfh0_-PQxHlgN8MPIGwVN0YBfwO9EMQxQ92cEAb818g5DloZg/viewform?usp=sharing&ouid=105802488582507153521';
            window.open(googleFormUrl, '_blank', 'noopener,noreferrer');
        }

        // Unduh Berkas - redirect to Google Drive
        function unduhBerkas() {
            // Replace this URL with your actual Google Drive folder URL
            const googleDriveUrl = ' https://drive.google.com/drive/folders/1K3HrgnSCTvUbxoYY5fK4XI1cvo4WxANS?usp=sharing';
            window.open(googleDriveUrl, '_blank', 'noopener,noreferrer');
        }

        // Advanced Photo Editor functionality
        let currentPhotoEmployeeId = null;
        let originalImage = null;
        let photoCanvas = null;
        let photoCtx = null;
        
        // Transform properties
        let imageTransform = {
            x: 0,
            y: 0,
            scale: 1,
            rotation: 0,
            flipX: 1,
            flipY: 1
        };
        
        // Crop properties
        let cropMode = false;
        let cropBox = { x: 0, y: 0, width: 0, height: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let dragMode = 'move'; // 'move', 'resize'
        let resizeHandle = null;

        // Upload photo
        function uploadPhoto(id) {
            currentPhotoEmployeeId = id;
            showPhotoUploadModal();
        }

        // Show photo upload modal
        function showPhotoUploadModal() {
            document.getElementById('photoUploadModal').classList.remove('hidden');
            document.getElementById('photoUploadModal').classList.add('flex');
            resetPhotoEditor();
        }

        // Hide photo upload modal
        function hidePhotoUploadModal() {
            document.getElementById('photoUploadModal').classList.add('hidden');
            document.getElementById('photoUploadModal').classList.remove('flex');
            resetPhotoEditor();
            currentPhotoEmployeeId = null;
        }

        // Setup photo editor
        function setupPhotoEditor() {
            photoCanvas = document.getElementById('photoCanvas');
            photoCtx = photoCanvas.getContext('2d');

            // Set canvas size
            photoCanvas.width = 600;
            photoCanvas.height = 400;

            // Canvas event listeners
            photoCanvas.addEventListener('mousedown', handleCanvasMouseDown);
            photoCanvas.addEventListener('mousemove', handleCanvasMouseMove);
            photoCanvas.addEventListener('mouseup', handleCanvasMouseUp);
            photoCanvas.addEventListener('wheel', handleCanvasWheel);

            // Transform controls
            document.getElementById('zoomSlider').addEventListener('input', handleZoomChange);
            document.getElementById('positionX').addEventListener('input', handlePositionChange);
            document.getElementById('positionY').addEventListener('input', handlePositionChange);
            document.getElementById('rotationSlider').addEventListener('input', handleRotationChange);

            // Filter controls
            document.getElementById('brightnessSlider').addEventListener('input', updateFilterValues);
            document.getElementById('contrastSlider').addEventListener('input', updateFilterValues);
            document.getElementById('saturationSlider').addEventListener('input', updateFilterValues);
            document.getElementById('blurSlider').addEventListener('input', updateFilterValues);

            // Action buttons
            document.getElementById('rotateLeft').addEventListener('click', () => rotatePhoto(-90));
            document.getElementById('rotateRight').addEventListener('click', () => rotatePhoto(90));
            document.getElementById('flipHorizontal').addEventListener('click', flipHorizontal);
            document.getElementById('flipVertical').addEventListener('click', flipVertical);
            document.getElementById('resetPhoto').addEventListener('click', resetPhotoEditor);
            document.getElementById('fitToCanvas').addEventListener('click', fitImageToCanvas);
            document.getElementById('centerImage').addEventListener('click', centerImage);

            // Crop controls
            document.getElementById('enableCrop').addEventListener('click', enableCropMode);
            document.getElementById('applyCrop').addEventListener('click', applyCrop);
            document.getElementById('cancelCrop').addEventListener('click', cancelCrop);

            // Preview click
            document.getElementById('previewImage').addEventListener('click', showPhotoEditor);
        }

        // Handle photo selection
        function handlePhotoSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file terlalu besar! Maksimal 5MB.');
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('File harus berupa gambar!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    showPhotoPreview(e.target.result);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Show photo preview
        function showPhotoPreview(src) {
            const previewImage = document.getElementById('previewImage');
            previewImage.src = src;
            document.getElementById('photoPreview').classList.remove('hidden');
            
            // Automatically show photo editor
            setTimeout(() => {
                showPhotoEditor();
            }, 100);
        }

        // Show photo editor
        function showPhotoEditor() {
            if (!originalImage) return;
            
            document.getElementById('photoEditor').classList.remove('hidden');
            resetTransform();
            drawImageToCanvas();
        }

        // Reset transform
        function resetTransform() {
            imageTransform = {
                x: 0,
                y: 0,
                scale: 1,
                rotation: 0,
                flipX: 1,
                flipY: 1
            };
            updateControlValues();
        }

        // Update control values
        function updateControlValues() {
            document.getElementById('zoomSlider').value = imageTransform.scale * 100;
            document.getElementById('zoomValue').textContent = Math.round(imageTransform.scale * 100) + '%';
            document.getElementById('positionX').value = Math.round(imageTransform.x);
            document.getElementById('positionY').value = Math.round(imageTransform.y);
            document.getElementById('rotationSlider').value = imageTransform.rotation;
            document.getElementById('rotationValue').textContent = Math.round(imageTransform.rotation) + '°';
        }

        // Update filter values
        function updateFilterValues() {
            const brightness = document.getElementById('brightnessSlider').value;
            const contrast = document.getElementById('contrastSlider').value;
            const saturation = document.getElementById('saturationSlider').value;
            const blur = document.getElementById('blurSlider').value;

            document.getElementById('brightnessValue').textContent = brightness + '%';
            document.getElementById('contrastValue').textContent = contrast + '%';
            document.getElementById('saturationValue').textContent = saturation + '%';
            document.getElementById('blurValue').textContent = blur + 'px';

            drawImageToCanvas();
        }

        // Draw image to canvas
        function drawImageToCanvas() {
            if (!originalImage) return;

            // Clear canvas
            photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);

            // Apply filters
            const brightness = document.getElementById('brightnessSlider').value;
            const contrast = document.getElementById('contrastSlider').value;
            const saturation = document.getElementById('saturationSlider').value;
            const blur = document.getElementById('blurSlider').value;

            photoCtx.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%) blur(${blur}px)`;

            // Save context
            photoCtx.save();

            // Move to center of canvas
            photoCtx.translate(photoCanvas.width / 2, photoCanvas.height / 2);

            // Apply transformations
            photoCtx.translate(imageTransform.x, imageTransform.y);
            photoCtx.rotate((imageTransform.rotation * Math.PI) / 180);
            photoCtx.scale(imageTransform.scale * imageTransform.flipX, imageTransform.scale * imageTransform.flipY);

            // Calculate image dimensions
            const imgWidth = originalImage.width;
            const imgHeight = originalImage.height;

            // Draw image centered
            photoCtx.drawImage(originalImage, -imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);

            // Restore context
            photoCtx.restore();
        }

        // Canvas mouse events
        function handleCanvasMouseDown(e) {
            if (cropMode) return;

            const rect = photoCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            isDragging = true;
            dragStart = { x: x - imageTransform.x, y: y - imageTransform.y };
        }

        function handleCanvasMouseMove(e) {
            if (!isDragging || cropMode) return;

            const rect = photoCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            imageTransform.x = x - dragStart.x;
            imageTransform.y = y - dragStart.y;

            updateControlValues();
            drawImageToCanvas();
        }

        function handleCanvasMouseUp(e) {
            isDragging = false;
        }

        // Canvas wheel event for zoom
        function handleCanvasWheel(e) {
            e.preventDefault();
            
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            imageTransform.scale = Math.max(0.1, Math.min(5, imageTransform.scale * zoomFactor));
            
            updateControlValues();
            drawImageToCanvas();
        }

        // Handle control changes
        function handleZoomChange(e) {
            imageTransform.scale = e.target.value / 100;
            updateControlValues();
            drawImageToCanvas();
        }

        function handlePositionChange() {
            imageTransform.x = parseFloat(document.getElementById('positionX').value) || 0;
            imageTransform.y = parseFloat(document.getElementById('positionY').value) || 0;
            drawImageToCanvas();
        }

        function handleRotationChange(e) {
            imageTransform.rotation = parseFloat(e.target.value);
            updateControlValues();
            drawImageToCanvas();
        }

        // Transform actions
        function rotatePhoto(degrees) {
            imageTransform.rotation = (imageTransform.rotation + degrees) % 360;
            updateControlValues();
            drawImageToCanvas();
        }

        function flipHorizontal() {
            imageTransform.flipX *= -1;
            drawImageToCanvas();
        }

        function flipVertical() {
            imageTransform.flipY *= -1;
            drawImageToCanvas();
        }

        function fitImageToCanvas() {
            if (!originalImage) return;

            const canvasRatio = photoCanvas.width / photoCanvas.height;
            const imageRatio = originalImage.width / originalImage.height;

            if (imageRatio > canvasRatio) {
                imageTransform.scale = photoCanvas.width / originalImage.width;
            } else {
                imageTransform.scale = photoCanvas.height / originalImage.height;
            }

            imageTransform.x = 0;
            imageTransform.y = 0;
            updateControlValues();
            drawImageToCanvas();
        }

        function centerImage() {
            imageTransform.x = 0;
            imageTransform.y = 0;
            updateControlValues();
            drawImageToCanvas();
        }

        // Crop functionality
        function enableCropMode() {
            cropMode = true;
            document.getElementById('enableCrop').classList.add('hidden');
            document.getElementById('applyCrop').classList.remove('hidden');
            document.getElementById('cancelCrop').classList.remove('hidden');
            
            // Set initial crop box
            cropBox = {
                x: photoCanvas.width * 0.25,
                y: photoCanvas.height * 0.25,
                width: photoCanvas.width * 0.5,
                height: photoCanvas.height * 0.5
            };
            
            showCropBox();
        }

        function showCropBox() {
            const cropBoxElement = document.getElementById('cropBox');
            const cropHandles = document.getElementById('cropHandles');
            
            cropBoxElement.style.display = 'block';
            cropHandles.style.display = 'block';
            
            updateCropBoxDisplay();
        }

        function updateCropBoxDisplay() {
            const cropBoxElement = document.getElementById('cropBox');
            cropBoxElement.style.left = cropBox.x + 'px';
            cropBoxElement.style.top = cropBox.y + 'px';
            cropBoxElement.style.width = cropBox.width + 'px';
            cropBoxElement.style.height = cropBox.height + 'px';
        }

        function applyCrop() {
            // Create a new canvas for cropped image
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = cropBox.width;
            tempCanvas.height = cropBox.height;
            
            // Draw cropped portion
            tempCtx.drawImage(photoCanvas, cropBox.x, cropBox.y, cropBox.width, cropBox.height, 0, 0, cropBox.width, cropBox.height);
            
            // Update main canvas
            photoCanvas.width = cropBox.width;
            photoCanvas.height = cropBox.height;
            photoCtx.drawImage(tempCanvas, 0, 0);
            
            cancelCrop();
        }

        function cancelCrop() {
            cropMode = false;
            document.getElementById('enableCrop').classList.remove('hidden');
            document.getElementById('applyCrop').classList.add('hidden');
            document.getElementById('cancelCrop').classList.add('hidden');
            
            document.getElementById('cropBox').style.display = 'none';
            document.getElementById('cropHandles').style.display = 'none';
        }

        // Reset photo editor
        function resetPhotoEditor() {
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoEditor').classList.add('hidden');
            document.getElementById('photoInput').value = '';
            
            // Reset sliders
            document.getElementById('brightnessSlider').value = 100;
            document.getElementById('contrastSlider').value = 100;
            document.getElementById('saturationSlider').value = 100;
            document.getElementById('blurSlider').value = 0;
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('rotationSlider').value = 0;
            document.getElementById('positionX').value = 0;
            document.getElementById('positionY').value = 0;
            
            // Reset values
            resetTransform();
            originalImage = null;
            cancelCrop();
            
            // Update display values
            updateFilterValues();
            updateControlValues();
        }

        // Save photo
        async function handleSavePhoto() {
            if (!photoCanvas || !currentPhotoEmployeeId) return;

            try {
                document.getElementById('savePhotoSpinner').classList.remove('hidden');
                
                // Create final canvas with square aspect ratio for profile photo
                const finalCanvas = document.createElement('canvas');
                const finalCtx = finalCanvas.getContext('2d');
                finalCanvas.width = 300;
                finalCanvas.height = 300;
                
                // Draw current canvas content to final canvas (centered and scaled)
                const scale = Math.min(300 / photoCanvas.width, 300 / photoCanvas.height);
                const scaledWidth = photoCanvas.width * scale;
                const scaledHeight = photoCanvas.height * scale;
                const offsetX = (300 - scaledWidth) / 2;
                const offsetY = (300 - scaledHeight) / 2;
                
                finalCtx.fillStyle = '#ffffff';
                finalCtx.fillRect(0, 0, 300, 300);
                finalCtx.drawImage(photoCanvas, offsetX, offsetY, scaledWidth, scaledHeight);
                
                // Get image data
                const imageData = finalCanvas.toDataURL('image/jpeg', 0.9);
                
                // Update employee photo in Firebase
                await updateEmployeeInFirebase(currentPhotoEmployeeId, {
                    photo: imageData,
                    updatedAt: new Date().toISOString()
                });

                hidePhotoUploadModal();
                alert('Foto berhasil disimpan!');
            } catch (error) {
                alert('Gagal menyimpan foto: ' + error.message);
            } finally {
                document.getElementById('savePhotoSpinner').classList.add('hidden');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribeEmployees) {
                unsubscribeEmployees();
            }
        });

        // Create animated particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 15;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Animate counter numbers
        function animateCounter(element, target, duration = 2000) {
            const start = parseInt(element.textContent) || 0;
            const increment = (target - start) / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current);
            }, 16);
        }

        // Enhanced update statistics with animations
        function updateStatisticsAnimated() {
            // Get current values
            const currentTotal = parseInt(document.getElementById('totalEmployees').textContent) || 0;
            const currentAllLeaves = parseInt(document.getElementById('totalAllLeaves').textContent) || 0;
            
            // Calculate new values
            const newTotal = employees.length;
            
            const leaveTypes = {
                'Cuti Tahunan': 0,
                'Cuti Besar': 0,
                'Cuti Alasan Penting': 0,
                'Cuti Sakit': 0,
                'Cuti Melahirkan': 0,
                'Cuti Diluar Tanggungan Negara': 0
            };

            let totalAllLeaves = 0;

            employees.forEach(employee => {
                if (employee.cuti) {
                    leaveTypes['Cuti Tahunan'] += employee.cuti.tahunan || 0;
                    leaveTypes['Cuti Besar'] += employee.cuti.besar || 0;
                    leaveTypes['Cuti Alasan Penting'] += employee.cuti.penting || 0;
                    leaveTypes['Cuti Sakit'] += employee.cuti.sakit || 0;
                    leaveTypes['Cuti Melahirkan'] += employee.cuti.melahirkan || 0;
                    leaveTypes['Cuti Diluar Tanggungan Negara'] += employee.cuti.diluar || 0;

                    totalAllLeaves += Object.values(employee.cuti).reduce((sum, val) => sum + (val || 0), 0);
                }
            });

            // Find most used leave type
            let mostUsedType = 'Tidak ada data';
            let mostUsedCount = 0;

            for (const [type, count] of Object.entries(leaveTypes)) {
                if (count > mostUsedCount) {
                    mostUsedCount = count;
                    mostUsedType = type;
                }
            }

            // Animate counters
            if (currentTotal !== newTotal) {
                animateCounter(document.getElementById('totalEmployees'), newTotal);
            }
            if (currentAllLeaves !== totalAllLeaves) {
                animateCounter(document.getElementById('totalAllLeaves'), totalAllLeaves);
            }
            
            // Update other elements
            document.getElementById('mostUsedLeaveType').textContent = mostUsedType;
            document.getElementById('mostUsedLeaveCount').textContent = `${mostUsedCount} hari`;
        }

        // Override the original updateStatistics function
        function updateStatistics() {
            updateStatisticsAnimated();
        }

        // Add staggered animation to employee cards
        function renderEmployeesWithAnimation(employeeList = employees) {
            const grid = document.getElementById('employeeGrid');
            grid.innerHTML = '';

            employeeList.forEach((employee, index) => {
                const totalCuti = employee.cuti ? Object.values(employee.cuti).reduce((sum, val) => sum + (val || 0), 0) : 0;
                
                const card = document.createElement('div');
                card.className = 'glass-card rounded-2xl shadow-2xl hover:shadow-3xl transition-all duration-500 cursor-pointer transform hover:-translate-y-2 hover:scale-105 grid-item card-hover relative overflow-hidden';
                card.style.animationDelay = `${index * 0.1}s`;
                card.onclick = () => showEmployeeDetail(employee.id);
                
                card.innerHTML = `
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-purple-400/10 to-pink-400/10 rounded-full -mr-10 -mt-10"></div>
                    <div class="p-6 relative z-10">
                        <div class="text-center mb-6">
                            <div class="flex items-center justify-center border-4 border-white shadow-2xl mx-auto mb-4 pulse-glow" style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, #667eea, #764ba2);">
                                ${employee.photo ? 
                                    `<img src="${employee.photo}" alt="${employee.name}" style="width: 100%; height: 100%; object-fit: cover; object-position: center; border-radius: 50%;">` :
                                    `<span class="text-white font-bold text-2xl">${employee.name.split(' ').map(n => n[0]).join('').substring(0, 2)}</span>`
                                }
                            </div>
                            <h3 class="font-bold text-gray-800 text-xl leading-tight mb-2 gradient-text">${employee.name}</h3>
                            <p class="text-sm text-gray-600 mb-1 font-medium">${employee.position}</p>
                            <p class="text-xs text-gray-500 bg-gray-100 rounded-full px-3 py-1 inline-block">NIP: ${employee.nip}</p>
                        </div>
                        <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-4 border border-red-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-700 font-medium">Total Cuti Terpakai:</span>
                                <span class="text-3xl font-bold bg-gradient-to-r from-red-500 to-pink-600 bg-clip-text text-transparent counter">${totalCuti}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-xs text-gray-600">hari</p>
                                <div class="w-16 h-1 bg-gradient-to-r from-red-400 to-pink-500 rounded-full"></div>
                            </div>
                        </div>
                        ${isAdminMode ? `
                            <div class="mt-6 pt-4 border-t border-gray-200 space-y-3">
                                <button onclick="event.stopPropagation(); editEmployee('${employee.id}')" 
                                        class="w-full bg-gradient-to-r from-blue-100 to-indigo-100 hover:from-blue-200 hover:to-indigo-200 text-blue-700 py-3 px-4 rounded-xl text-sm font-medium transition-all duration-300 btn-ripple transform hover:scale-105 tooltip" data-tooltip="Edit informasi pegawai">
                                    ✏️ Edit Data
                                </button>
                                <button onclick="event.stopPropagation(); uploadPhoto('${employee.id}')" 
                                        class="w-full bg-gradient-to-r from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 text-green-700 py-3 px-4 rounded-xl text-sm font-medium transition-all duration-300 btn-ripple transform hover:scale-105 tooltip" data-tooltip="Upload atau edit foto">
                                    📷 Upload Foto
                                </button>
                                <button onclick="event.stopPropagation(); deleteEmployee('${employee.id}')" 
                                        class="w-full bg-gradient-to-r from-red-100 to-pink-100 hover:from-red-200 hover:to-pink-200 text-red-700 py-3 px-4 rounded-xl text-sm font-medium transition-all duration-300 btn-ripple transform hover:scale-105 tooltip" data-tooltip="Hapus pegawai dari sistem">
                                    🗑️ Hapus Pegawai
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Search functionality
        function handleSearch(e) {
            searchQuery = e.target.value.toLowerCase().trim();
            
            if (searchQuery === '') {
                clearSearch();
                return;
            }
            
            // Filter employees based on search query
            filteredEmployees = employees.filter(employee => {
                return employee.name.toLowerCase().includes(searchQuery) ||
                       employee.nip.toLowerCase().includes(searchQuery) ||
                       employee.position.toLowerCase().includes(searchQuery);
            });
            
            // Show clear button
            document.getElementById('clearSearch').classList.remove('hidden');
            
            // Update search results display
            updateSearchResults();
            
            // Render filtered employees
            renderEmployeesWithAnimation(filteredEmployees);
        }
        
        function clearSearch() {
            searchQuery = '';
            filteredEmployees = [];
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.add('hidden');
            document.getElementById('searchResults').classList.add('hidden');
            
            // Render all employees
            renderEmployeesWithAnimation(employees);
        }
        
        function updateSearchResults() {
            const searchResults = document.getElementById('searchResults');
            const searchResultText = document.getElementById('searchResultText');
            
            if (filteredEmployees.length === 0) {
                searchResultText.innerHTML = `
                    <span class="text-red-600 font-medium">❌ Tidak ditemukan pegawai dengan kata kunci "${searchQuery}"</span>
                    <br>
                    <span class="text-gray-500 text-xs mt-1">Coba gunakan kata kunci lain atau periksa ejaan</span>
                `;
            } else if (filteredEmployees.length === 1) {
                searchResultText.innerHTML = `
                    <span class="text-green-600 font-medium">✅ Ditemukan 1 pegawai dengan kata kunci "${searchQuery}"</span>
                `;
            } else {
                searchResultText.innerHTML = `
                    <span class="text-blue-600 font-medium">📋 Ditemukan ${filteredEmployees.length} pegawai dengan kata kunci "${searchQuery}"</span>
                `;
            }
            
            searchResults.classList.remove('hidden');
        }

        // Override the original renderEmployees function
        function renderEmployees() {
            const employeesToRender = searchQuery ? filteredEmployees : employees;
            renderEmployeesWithAnimation(employeesToRender);
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            init();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98abba9be77cfd9e',t:'MTc1OTgyMjYwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
