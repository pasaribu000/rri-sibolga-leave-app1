import React, { useEffect, useMemo, useState, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import firebase from 'firebase/compat/app';
import 'firebase/compat/auth';
import 'firebase/compat/firestore';

// Pastikan Lucide Icons diinisialisasi
useEffect(() => {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

// ====== Komponen Modal Catatan ======
function NotesModal({ show, onClose, notes, onSave, isAdmin, setMessage }) {
    const [isEditing, setIsEditing] = useState(false);
    const [currentNotes, setCurrentNotes] = useState(notes || '');

    useEffect(() => {
        // Sinkronkan catatan saat modal dibuka
        setCurrentNotes(notes);
        if (!isAdmin) {
            setIsEditing(false);
        }
    }, [notes, isAdmin]);

    const handleSave = async () => {
        try {
            await onSave(currentNotes);
            setIsEditing(false);
            setMessage({ text: "Catatan berhasil disimpan!", type: "success" });
        } catch (error) {
            setMessage({ text: "Gagal menyimpan catatan. Coba lagi.", type: "error" });
            console.error("Failed to save notes:", error);
        }
    };

    const handleCancel = () => {
        setIsEditing(false);
        setCurrentNotes(notes);
    };

    if (!show) {
        return null;
    }

    return (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[1000] p-4">
            <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg transform transition-all">
                <div className="flex justify-between items-center pb-3">
                    <h3 className="text-2xl font-bold text-gray-900">Catatan Cuti</h3>
                    <button onClick={onClose} className="p-2 text-gray-500 hover:text-gray-700 transition-colors duration-200">
                        <i data-lucide="x" className="w-6 h-6"></i>
                    </button>
                </div>
                {isEditing ? (
                    <div className="modal-content">
                        <textarea
                            className="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none"
                            value={currentNotes}
                            onChange={(e) => setCurrentNotes(e.target.value)}
                            placeholder="Tulis catatan di sini..."
                        ></textarea>
                        <div className="flex justify-end space-x-2 mt-4">
                            <button onClick={handleCancel} className="bg-gray-300 text-gray-800 px-4 py-2 rounded-full font-semibold hover:bg-gray-400 transition-colors duration-200">Batal</button>
                            <button onClick={handleSave} className="bg-green-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-green-600 transition-colors duration-200">Simpan</button>
                        </div>
                    </div>
                ) : (
                    <div className="modal-content">
                        <div className="p-3 bg-gray-100 rounded-lg border border-gray-200 max-h-40 overflow-y-auto">
                            <p className="text-gray-700 whitespace-pre-wrap">{notes || 'Tidak ada catatan.'}</p>
                        </div>
                        {isAdmin && (
                            <div className="flex justify-end mt-4">
                                <button onClick={() => setIsEditing(true)} className="bg-blue-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-blue-600 transition-colors duration-200">Edit</button>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
}

// ====== Firebase Config (SAMA seperti file Anda) ======
const firebaseConfig = {
    apiKey: "AIzaSyBBDMhvpAboYaEUIfo0eyzjZxK6iZyQwpo",
    authDomain: "cutirri.firebaseapp.com",
    projectId: "cutirri",
    storageBucket: "cutirri.firebasestorage.app",
    messagingSenderId: "310950239670",
    appId: "1:310950239670:web:3b58351db2c5946f8c3517",
    measurementId: "G-BENDLYTZ2Z"
};

// App constants
const appId = "default-app-id";
const correctAdminPassword = "rriadmin2025";
const initialEmployees = ["Yanni Peter Latuheru, S.Sos", "Ichwansyah Pohan, S.E", "Rosmawan Hutabarat, S.E", "Viktor Hamonangan Hutabarat", "Khairil", "Vivi Tri Doharny Daulay", "Diskatarisa Hutabarat", "Novita Sari Putri S.E", "Silverius Hamonangan P. Purba, S.Sos", "Frans Martuani Sinaga, S.M", "Ade Wulan Septyaningsih, S.IP", "Nurhamni Ichwarti, S.Sos", "Citra Priadi Pasaribu, S.IP", "Azis Fahri Tanjung, S.Kom", "Annisa Lestari Nasution, A.Md.Ak", "Putri Andriani, A.Md.Ak", "Mahani Aprilia, A.Md.Ak", "Idola Pratiwi Sinaga, A.md.Pjk", "Ray Wiranta, A.Md.A.B", "Indah Farima Putri, A.Md", "Hans Pierre Sitohang, A.Md", "Sopiah Hasibuan, A.Md", "Aziziah khurfatul Janah, A.Md.Ds", "Astrid khairani Sinaga, A.Md", "Intan Friskila hondro, A.Md", "Anna Theresia Simatupang, S.Sos", "Desi Suriani Pasaribu, S.E", "Rindu Fatmawaty, S.H", "Gerhanawati, S.E", "Ismail Marzuki, S.Sos", "Ronny Ferdian, S.E", "Safran Nuh Nasution, S.T", "M.Khalis Pasaribu, S.Ikom", "Eko Putra Hutabarat, A.Md", "Ahmad Ridho Siregar, A.Md.T", "Ahlis Jami'ah Damanik, A.Md.Kom", "Deliana Nasution", "Widya Sartika Nasution", "Paulus Hadi", "Ahmad Ferdian", "Anhar Rianto Pasaribu", "Deny Siahaan", "Abdul Jalil", "Dedi Hariadi", "Edi Suheri", "Muafdan Jega", "Joyful Rom Sihotang", "James Fransiskus", "Jonni Sihombing", "Martha Monica Putri Siahaan, S.T", "Erni Sasmita, S.E", "Wilson Pangihutan Siregar", "Welly Boy Simatupang, S.E", "Eva Meylina Siahaan", "Flora Susanti Lumbantobing", "Ester Tampubolon", "Bernard Adi Saputra Saragih", "Felix Simatupang", "Mukhtadinul Ikhsan", "Halasson Siahaan", "Mahar Yusuf Sinaga", "Irfan Sihotang", "Rizky Ramadhan Piliang", "Andrian Mendrofa"];

const leaveTypes = [
    { key: 'annual', label: 'Cuti Tahunan Terpakai' },
    { key: 'long', label: 'Cuti Besar Terpakai' },
    { key: 'sick', label: 'Cuti Sakit Terpakai' },
    { key: 'maternity', label: 'Cuti Melahirkan Terpakai' },
    { key: 'important', label: 'Cuti Alasan Penting Terpakai' },
    { key: 'outside', label: 'Cuti Di Luar Tanggungan Terpakai' },
];

const parseCSV = (csv) => {
    const lines = csv.split('\n');
    const headers = ['Timestamp', 'Nama Pegawai', 'Jenis Cuti', 'Tanggal Mulai Cuti', 'Tanggal Selesai Cuti', 'Unggah Berkas Persyaratan', 'Alamat Email Pegawai'];
    const data = [];
    const numExpectedColumns = headers.length;

    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue;
        const values = lines[i].split(',').map(v => v.trim());
        const obj = {};

        if (values.length > numExpectedColumns) {
            const timestamp = values[0];
            const email = values[values.length - 1];
            const uploadLink = values[values.length - 2];
            const endDate = values[values.length - 3];
            const startDate = values[values.length - 4];
            const leaveType = values[values.length - 5];

            const nameParts = values.slice(1, values.length - 5);
            const name = nameParts.join(', ');

            const newValues = [timestamp, name, leaveType, startDate, endDate, uploadLink, email];

            headers.forEach((header, index) => {
                obj[header] = newValues[index];
            });

        } else {
            headers.forEach((header, index) => {
                obj[header] = values[index];
            });
        }
        data.push(obj);
    }
    return data;
};

function Header({ currentTime }) {
    useEffect(() => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
    return (
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <div className="flex items-center space-x-4">
                <i data-lucide="radio" className="w-10 h-10 text-indigo-600"></i>
                <h1 className="text-4xl font-bold text-gray-800 tracking-wide">RRI Sibolga</h1>
            </div>
            <div className="text-right">
                <p className="text-lg font-medium text-gray-600">
                    {currentTime.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                </p>
                <p className="text-2xl font-bold text-indigo-600">
                    {currentTime.toLocaleTimeString('id-ID')}
                </p>
            </div>
        </div>
    );
}

function Calendar({ onClose }) {
    const [currentMonth, setCurrentMonth] = useState(new Date());
    const daysInMonth = useMemo(() => {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const lastDay = new Date(year, month + 1, 0).getDate();
        return Array.from({ length: lastDay }, (_, i) => i + 1);
    }, [currentMonth]);

    const firstDayOffset = useMemo(() => {
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        return firstDay.getDay();
    }, [currentMonth]);

    const monthYear = currentMonth.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

    useEffect(() => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    return (
        <div className="bg-white rounded-2xl shadow-xl p-8 space-y-6 max-w-2xl w-full border-t-8 border-yellow-500">
            <div className="flex items-center justify-between mb-4">
                <button onClick={() => setCurrentMonth(d => new Date(d.getFullYear(), d.getMonth() - 1, 1))} className="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="chevron-left" className="w-6 h-6"></i>
                </button>
                <h3 className="text-xl font-bold text-gray-800">{monthYear}</h3>
                <button onClick={() => setCurrentMonth(d => new Date(d.getFullYear(), d.getMonth() + 1, 1))} className="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="chevron-right" className="w-6 h-6"></i>
                </button>
            </div>
            <div className="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500">
                {['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map(d => <div key={d}>{d}</div>)}
            </div>
            <div className="grid grid-cols-7 gap-2">
                {Array.from({ length: firstDayOffset }).map((_, i) => (<div key={'e' + i} className="p-2"></div>))}
                {daysInMonth.map(day => (
                    <div key={day} className="p-3 bg-gray-100 rounded-lg text-center font-medium transition-all hover:bg-indigo-200 cursor-pointer">
                        {day}
                    </div>
                ))}
            </div>
            <button onClick={onClose} className="mt-8 w-full flex items-center justify-center px-6 py-3 bg-red-500 text-white font-bold rounded-full text-lg hover:bg-red-600 shadow-lg">
                <i data-lucide="x" className="w-5 h-5 mr-2"></i> Tutup Kalender
            </button>
        </div>
    );
}

function App() {
    const [currentTime, setCurrentTime] = useState(new Date());
    const [isLoading, setIsLoading] = useState(true);
    const [userId, setUserId] = useState(null);
    const [isAdmin, setIsAdmin] = useState(false);
    const [showPasswordInput, setShowPasswordInput] = useState(false);
    const [adminPassword, setAdminPassword] = useState('');
    const [message, setMessage] = useState({ text: '', type: '' });
    const [employees, setEmployees] = useState([]);
    const [leaveQuotas, setLeaveQuotas] = useState([]);
    const [selectedEmployee, setSelectedEmployee] = useState(null);
    const [searchQuery, setSearchQuery] = useState('');
    const [editData, setEditData] = useState({});
    const [isSaving, setIsSaving] = useState({});
    const [showFlow, setShowFlow] = useState(false);
    const [showCalendar, setShowCalendar] = useState(false);
    
    // ====== State untuk Modal Catatan ======
    const [showNotesModal, setShowNotesModal] = useState(false);
    const [notesModalData, setNotesModalData] = useState({ notes: '', employeeId: null, leaveType: null });
    // =====================================

    useEffect(() => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    useEffect(() => {
        const t = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(t);
    }, []);

    useEffect(() => {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.signInAnonymously().catch(console.error);
        const stop = auth.onAuthStateChanged(u => {
            setUserId(u ? u.uid : null);
            setIsLoading(false);
        });
        return () => stop();
    }, []);

    useEffect(() => {
        const db = firebase.firestore();
        const ref = db.collection(`artifacts/${appId}/public/data/employees`);

        const ensureSeed = async () => {
            const snap = await ref.get();
            if (snap.empty) {
                const batch = db.batch();
                initialEmployees.forEach(name => {
                    const docRef = ref.doc();
                    batch.set(docRef, {
                        name,
                        // === PENTING: Struktur data baru dengan notes ===
                        leaves: {
                            annual: { used: 0, notes: '' },
                            long: { used: 0, notes: '' },
                            sick: { used: 0, notes: '' },
                            maternity: { used: 0, notes: '' },
                            important: { used: 0, notes: '' },
                            outside: { used: 0, notes: '' }
                        }
                    });
                });
                await batch.commit();
            }
        };

        ensureSeed().catch(console.error);

        const unsub = ref.onSnapshot(snap => {
            const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setEmployees(arr);
            if (!selectedEmployee && arr.length) setSelectedEmployee(arr[0]);
        }, err => {
            console.error(err);
            setMessage({ text: "Gagal memuat data cuti.", type: "error" });
        });
        return () => unsub();
    }, []);

    useEffect(() => {
        const db = firebase.firestore();
        const ref = db.collection(`artifacts/${appId}/public/data/leaveQuotas`);

        const initialQuotas = [
            { type: 'Cuti Tahunan', quota: '12 hari', order: 1 },
            { type: 'Cuti Besar', quota: '3 bulan', order: 2 },
            { type: 'Cuti Sakit', quota: '14 hari', order: 3 },
            { type: 'Cuti Melahirkan', quota: '3 bulan', order: 4 },
            { type: 'Cuti Karena Alasan Penting', quota: '1 bulan', order: 5 },
            { type: 'Cuti Diluar Tanggungan Negara', quota: '3 tahun', order: 6 },
            { type: 'Cuti Bersama', quota: '7 hari', note: 'sewaktu-waktu dapat berubah', order: 7 },
        ];

        const ensureSeed = async () => {
            const snap = await ref.get();
            if (snap.empty) {
                const batch = db.batch();
                initialQuotas.forEach(q => {
                    const docRef = ref.doc();
                    batch.set(docRef, q);
                });
                await batch.commit();
            }
        };

        ensureSeed().catch(console.error);

        const unsub = ref.orderBy('order').onSnapshot(snap => {
            const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            setLeaveQuotas(arr);
        }, err => {
            console.error(err);
            setMessage({ text: "Gagal memuat kuota cuti.", type: "error" });
        });
        return () => unsub();
    }, []);

    const filtered = React.useMemo(
        () => employees.filter(e => e.name.toLowerCase().includes((searchQuery || '').toLowerCase())),
        [employees, searchQuery]
    );

    const toggleAdmin = () => {
        if (isAdmin) {
            setIsAdmin(false);
            setShowPasswordInput(false);
            setAdminPassword('');
        } else {
            setShowPasswordInput(true);
        }
        setShowFlow(false);
        setShowCalendar(false);
        setMessage({ text: '', type: '' });
    };

    const submitPassword = (e) => {
        e.preventDefault();
        if (adminPassword === correctAdminPassword) {
            setIsAdmin(true);
            setShowPasswordInput(false);
            setAdminPassword('');
            setMessage({ text: "Berhasil masuk sebagai Admin!", type: "success" });
        } else {
            setMessage({ text: "Kata sandi salah.", type: "error" });
        }
    };

    // Fungsi untuk memperbarui jumlah hari cuti
    const saveLeaves = async (empId, leaveType) => {
        setIsSaving(s => ({ ...s, [empId + leaveType]: true }));
        const db = firebase.firestore();
        const emp = employees.find(e => e.id === empId);
        const newLeaveUsed = (editData[empId] && editData[empId][leaveType]) ?? (emp.leaves[leaveType]?.used ?? 0);
        
        try {
            await db.collection(`artifacts/${appId}/public/data/employees`).doc(empId).update({
                [`leaves.${leaveType}.used`]: newLeaveUsed
            });
            setMessage({ text: "Jumlah hari cuti disimpan.", type: "success" });
        } catch (error) {
            console.error("Gagal menyimpan data cuti pegawai:", error);
            setMessage({ text: "Gagal menyimpan data cuti. Coba lagi.", type: "error" });
        } finally {
            setIsSaving(s => ({ ...s, [empId + leaveType]: false }));
            setEditData(prev => ({ ...prev, [empId]: { ...(prev[empId] || {}), [leaveType]: undefined } }));
        }
    };

    // Fungsi baru untuk memperbarui catatan cuti
    const saveNotes = async (newNotes) => {
        const { employeeId, leaveType } = notesModalData;
        if (!employeeId || !leaveType) return;

        const db = firebase.firestore();
        const docRef = db.collection(`artifacts/${appId}/public/data/employees`).doc(employeeId);
        
        // Simpan catatan ke Firebase
        await docRef.update({
            [`leaves.${leaveType}.notes`]: newNotes
        });
    };

    // Fungsi untuk menampilkan modal catatan
    const handleShowNotes = (employee, leaveType) => {
        setNotesModalData({
            notes: employee.leaves[leaveType]?.notes,
            employeeId: employee.id,
            leaveType: leaveType
        });
        setShowNotesModal(true);
    };

    const updateQuota = async (id, updatedFields) => {
        try {
            const db = firebase.firestore();
            await db.collection(`artifacts/${appId}/public/data/leaveQuotas`).doc(id).set(updatedFields, { merge: true });
            setMessage({ text: "Kuota cuti berhasil diperbarui.", type: "success" });
        } catch (error) {
            console.error("Gagal memperbarui kuota cuti:", error);
            setMessage({ text: "Gagal memperbarui kuota cuti. Coba lagi.", type: "error" });
        }
    };

    const deleteQuota = async (id) => {
        if (!window.confirm("Hapus jenis cuti ini?")) return;
        try {
            const db = firebase.firestore();
            await db.collection(`artifacts/${appId}/public/data/leaveQuotas`).doc(id).delete();
            setMessage({ text: "Jenis cuti berhasil dihapus.", type: "success" });
        } catch (error) {
            console.error("Gagal menghapus kuota cuti:", error);
            setMessage({ text: "Gagal menghapus kuota cuti. Coba lagi.", type: "error" });
        }
    };

    const addEmployee = async (name) => {
        const nm = (name || '').trim();
        if (!nm) return;
        const db = firebase.firestore();
        try {
            await db.collection(`artifacts/${appId}/public/data/employees`).add({
                name: nm,
                leaves: {
                    annual: { used: 0, notes: '' },
                    long: { used: 0, notes: '' },
                    sick: { used: 0, notes: '' },
                    maternity: { used: 0, notes: '' },
                    important: { used: 0, notes: '' },
                    outside: { used: 0, notes: '' }
                }
            });
            setMessage({ text: "Pegawai ditambahkan.", type: "success" });
        } catch (error) {
            console.error("Gagal menambahkan pegawai:", error);
            setMessage({ text: "Gagal menambahkan pegawai. Coba lagi.", type: "error" });
        }
    };

    const deleteEmployee = async (emp) => {
        if (!window.confirm(`Hapus pegawai: ${emp.name}?`)) return;
        const db = firebase.firestore();
        try {
            await db.collection(`artifacts/${appId}/public/data/employees`).doc(emp.id).delete();
            setMessage({ text: "Pegawai dihapus.", type: "success" });
        } catch (error) {
            console.error("Gagal menghapus pegawai:", error);
            setMessage({ text: "Gagal menghapus pegawai. Coba lagi.", type: "error" });
        }
    };

    const updateName = async (empId, newName) => {
        const nm = (newName || '').trim();
        if (!nm) return;
        const db = firebase.firestore();
        try {
            await db.collection(`artifacts/${appId}/public/data/employees`).doc(empId).set({
                name: nm
            }, { merge: true });
            setMessage({ text: "Nama diperbarui.", type: "success" });
        } catch (error) {
            console.error("Gagal memperbarui nama:", error);
            setMessage({ text: "Gagal memperbarui nama. Coba lagi.", type: "error" });
        }
    };

    // UI
    if (isLoading) return (
        <div className="flex items-center justify-center min-h-screen">
            <div className="text-xl font-semibold text-gray-700 animate-pulse">Memuat data…</div>
        </div>
    );

    return (
        <div className="max-w-7xl mx-auto p-4">
            <Header currentTime={currentTime} />

            {message.text && (
                <div className={`p-4 mb-4 text-white rounded-lg shadow-md flex items-center justify-between ${message.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
                    <span>{message.text}</span>
                    <button onClick={() => setMessage({ text: '', type: '' })} className="ml-4 p-1 rounded-full hover:bg-white/20">
                        <i data-lucide="x" className="w-5 h-5"></i>
                    </button>
                </div>
            )}

            <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div className="flex items-center gap-2 bg-gray-100 p-3 rounded-xl text-gray-600 text-sm">
                    <span className="font-semibold">User ID:</span> <span className="font-mono">{userId}</span>
                </div>
                <div className="flex flex-col items-end gap-2">
                    <button onClick={toggleAdmin} className={`px-6 py-2 rounded-full font-bold text-white shadow-lg ${isAdmin ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-500 hover:bg-indigo-600'}`}>
                        {isAdmin ? 'Beralih ke User' : 'Beralih ke Admin'}
                    </button>
                    {showPasswordInput && (
                        <form onSubmit={submitPassword} className="flex gap-2">
                            <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} placeholder="Kata sandi admin"
                                className="p-2 border-2 border-gray-300 rounded-full focus:border-indigo-500 focus:outline-none" />
                            <button type="submit" className="px-4 py-2 bg-green-500 text-white rounded-full font-semibold hover:bg-green-600">Masuk</button>
                        </form>
                    )}
                </div>
            </div>

            {isAdmin ? (
                <AdminPanel employees={employees} leaveTypes={leaveTypes} leaveQuotas={leaveQuotas} editData={editData} setEditData={setEditData}
                    saveLeaves={saveLeaves} updateQuota={updateQuota} deleteQuota={deleteQuota}
                    addEmployee={addEmployee} deleteEmployee={deleteEmployee} updateName={updateName} isSaving={isSaving} setMessage={setMessage}
                    handleShowNotes={handleShowNotes} />
            ) : (
                <UserPanel employees={employees} selectedEmployee={selectedEmployee} setSelectedEmployee={setSelectedEmployee}
                    leaveTypes={leaveTypes} leaveQuotas={leaveQuotas} searchQuery={searchQuery} setSearchQuery={setSearchQuery}
                    showFlow={showFlow} setShowFlow={setShowFlow} showCalendar={showCalendar} setShowCalendar={setShowCalendar}
                    handleShowNotes={handleShowNotes} />
            )}
            
            {/* ====== Panggil Komponen Modal ====== */}
            <NotesModal
                show={showNotesModal}
                onClose={() => setShowNotesModal(false)}
                notes={notesModalData.notes}
                onSave={saveNotes}
                isAdmin={isAdmin}
                setMessage={setMessage}
            />
        </div>
    );
}

function AdminPanel({ employees, leaveTypes, leaveQuotas, editData, setEditData, saveLeaves, addEmployee, deleteEmployee, updateName, isSaving, updateQuota, deleteQuota, setMessage, handleShowNotes }) {
    const [newName, setNewName] = useState('');
    const [editing, setEditing] = useState(null);
    const [editingName, setEditingName] = useState('');

    const [newQuotaType, setNewQuotaType] = useState('');
    const [newQuotaValue, setNewQuotaValue] = useState('');
    const [isAddingQuota, setIsAddingQuota] = useState(false);

    const [editingQuotaId, setEditingQuotaId] = useState(null);
    const [editingQuotaValue, setEditingQuotaValue] = useState('');
    const [savingQuotaId, setSavingQuotaId] = useState(null);

    useEffect(() => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    const handleAddQuota = async (e) => {
        e.preventDefault();
        if (newQuotaType && newQuotaValue) {
            setIsAddingQuota(true);
            const db = firebase.firestore();
            const ref = db.collection(`artifacts/${appId}/public/data/leaveQuotas`);
            try {
                const newOrder = leaveQuotas.length > 0 ? Math.max(...leaveQuotas.map(q => q.order || 0)) + 1 : 1;
                await ref.add({
                    type: newQuotaType,
                    quota: newQuotaValue,
                    order: newOrder,
                });
                setMessage({ text: "Kuota cuti baru berhasil ditambahkan.", type: "success" });
                setNewQuotaType('');
                setNewQuotaValue('');
            } catch (error) {
                console.error("Gagal menambahkan kuota cuti:", error);
                setMessage({ text: "Gagal menambahkan kuota cuti. Coba lagi.", type: "error" });
            } finally {
                setIsAddingQuota(false);
            }
        }
    };

    const handleEditQuotaClick = (quota) => {
        setEditingQuotaId(quota.id);
        setEditingQuotaValue(quota.quota);
    };

    const handleCancelEditQuotaClick = () => {
        setEditingQuotaId(null);
        setEditingQuotaValue('');
    };

    const handleSaveQuotaClick = async (quotaId) => {
        setSavingQuotaId(quotaId);
        await updateQuota(quotaId, { quota: editingQuotaValue });
        setSavingQuotaId(null);
        setEditingQuotaId(null);
        setEditingQuotaValue('');
    };

    const handleQuotaDelete = async (id) => {
        await deleteQuota(id);
    };

    return (
        <div className="space-y-6">
            <div className="bg-white rounded-2xl shadow-xl p-6 space-y-4 border-t-8 border-green-500">
                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="user-plus" className="w-6 h-6"></i> Tambah Pegawai Baru
                </h2>
                <form onSubmit={(e) => {
                    e.preventDefault();
                    addEmployee(newName);
                    setNewName('');
                }} className="flex flex-col md:flex-row gap-3">
                    <input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Nama Lengkap Pegawai…"
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring focus:ring-green-200 focus:outline-none" />
                    <button type="submit" className="px-6 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 shadow">Tambah</button>
                </form>
            </div>

            <div className="bg-white rounded-2xl shadow-xl p-6 space-y-4 border-t-8 border-yellow-500">
                <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="calendar" className="w-6 h-6"></i> Kelola Kuota Cuti
                    </h2>
                </div>
                
                <form onSubmit={handleAddQuota} className="bg-gray-100 p-4 rounded-xl flex flex-col md:flex-row gap-3 items-end">
                    <div className="flex-1">
                        <label htmlFor="newQuotaType" className="block text-sm font-semibold text-gray-700 mb-1">Jenis Cuti Baru</label>
                        <input id="newQuotaType" type="text" value={newQuotaType} onChange={e => setNewQuotaType(e.target.value)} placeholder="Misal: Cuti Lainnya"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:border-yellow-500 focus:outline-none" />
                    </div>
                    <div className="flex-1">
                        <label htmlFor="newQuotaValue" className="block text-sm font-semibold text-gray-700 mb-1">Kuota</label>
                        <input id="newQuotaValue" type="text" value={newQuotaValue} onChange={e => setNewQuotaValue(e.target.value)} placeholder="Misal: 5 hari"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:border-yellow-500 focus:outline-none" />
                    </div>
                    <button type="submit" disabled={isAddingQuota} className={`px-6 py-2 rounded-lg font-bold shadow w-full md:w-auto ${isAddingQuota ? 'bg-gray-400' : 'bg-green-500 text-white hover:bg-green-600'}`}>
                        {isAddingQuota ? 'Menambah...' : 'Tambah'}
                    </button>
                </form>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    {leaveQuotas.map(quota => (
                        <div key={quota.id} className="flex flex-col p-3 bg-gray-100 rounded-lg shadow-sm">
                            <div className="flex justify-between items-center mb-1">
                                <label className="text-sm font-semibold text-gray-600">{quota.type}</label>
                                <button onClick={() => handleQuotaDelete(quota.id)} disabled={savingQuotaId === quota.id} className={`p-1 rounded-full text-red-500 ${savingQuotaId === quota.id ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-100'}`}>
                                    <i data-lucide="trash-2" className="w-4 h-4"></i>
                                </button>
                            </div>
                            {editingQuotaId === quota.id ? (
                                <div className="flex gap-2">
                                    <input type="text"
                                        value={editingQuotaValue}
                                        onChange={e => setEditingQuotaValue(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:border-yellow-500 focus:outline-none"
                                    />
                                    <button onClick={() => handleSaveQuotaClick(quota.id)} disabled={savingQuotaId === quota.id} className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                        {savingQuotaId === quota.id ? <i data-lucide="loader-2" className="w-4 h-4 animate-spin"></i> : <i data-lucide="check" className="w-4 h-4"></i>}
                                    </button>
                                    <button onClick={handleCancelEditQuotaClick} className="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                        <i data-lucide="x" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            ) : (
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-800 font-bold">{quota.quota}</span>
                                    <button onClick={() => handleEditQuotaClick(quota)} className="p-1 rounded-full text-indigo-500 hover:bg-indigo-100">
                                        <i data-lucide="pencil" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            )}
                            {quota.note && <p className="text-xs italic text-red-500 mt-1">{quota.note}</p>}
                        </div>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {employees.map(emp => (
                    <div key={emp.id} className="bg-white rounded-2xl shadow-xl p-6 space-y-4 border-t-8 border-indigo-400">
                        {editing === emp.id ? (
                            <div className="flex items-center gap-2">
                                <input value={editingName} onChange={e => setEditingName(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none" />
                                <button onClick={() => {
                                    updateName(emp.id, editingName);
                                    setEditing(null);
                                    setEditingName('');
                                }} className="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                    <i data-lucide="check" className="w-4 h-4"></i>
                                </button>
                                <button onClick={() => {
                                    setEditing(null);
                                    setEditingName('');
                                }} className="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            </div>
                        ) : (
                            <div className="flex justify-between items-center">
                                <h2 className="text-lg font-bold text-gray-800">{emp.name}</h2>
                                <button onClick={() => {
                                    setEditing(emp.id);
                                    setEditingName(emp.name);
                                }} className="p-1 rounded-full text-indigo-500 hover:bg-indigo-100">
                                    <i data-lucide="pencil" className="w-4 h-4"></i>
                                </button>
                            </div>
                        )}
                        <div className="space-y-3 text-sm">
                            {leaveTypes.map(t => (
                                <div key={t.key} className="flex flex-col">
                                    <label className="text-gray-600 font-medium mb-1">{t.label}:</label>
                                    <div className="flex items-center gap-2">
                                        <input type="number"
                                            value={ (editData[emp.id] && editData[emp.id][t.key]) ?? (emp.leaves[t.key]?.used ?? 0) }
                                            onChange={e => setEditData(prev => ({ ...prev, [emp.id]: { ...(prev[emp.id] || {}), [t.key]: Number(e.target.value) } }))}
                                            className="w-20 p-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                                        />
                                        <button onClick={() => saveLeaves(emp.id, t.key)} className={`p-2 rounded-full ${isSaving[emp.id + t.key] ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600 text-white'}`}>
                                            {isSaving[emp.id + t.key] ? <i data-lucide="loader-2" className="w-4 h-4 animate-spin"></i> : <i data-lucide="save" className="w-4 h-4"></i>}
                                        </button>
                                        <button onClick={() => handleShowNotes(emp, t.key)} className="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600">
                                            <i data-lucide="sticky-note" className="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="flex gap-2 mt-4">
                            <button onClick={() => deleteEmployee(emp)} className="flex-1 px-4 py-2 bg-red-500 text-white font-bold rounded-full hover:bg-red-600 shadow">
                                Hapus
                            </button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function UserPanel({ employees, selectedEmployee, setSelectedEmployee, leaveTypes, leaveQuotas, searchQuery, setSearchQuery, showFlow, setShowFlow, showCalendar, setShowCalendar, handleShowNotes }) {
    const [todayLeaves, setTodayLeaves] = useState([]);
    useEffect(() => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    useEffect(() => {
        const fetchLeaveData = async () => {
            const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQg3iDe2R2fwIGjughldUclnZrOdkFRNVp0hXhWgHqakUXdqAlT-RyGNas8CO483ftqYuuu9IAGs0UZ/pub?gid=562275814&single=true&output=csv';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            try {
                const response = await fetch(spreadsheetUrl);
                const text = await response.text();
                const leaveData = parseCSV(text);
                const currentLeaves = leaveData.filter(leave => {
                    const rawStartDate = leave['Tanggal Mulai Cuti']?.split(' ')[0];
                    const rawEndDate = leave['Tanggal Selesai Cuti']?.split(' ')[0];
                    if (!rawStartDate || !rawEndDate) return false;

                    const [dayStart, monthStart, yearStart] = rawStartDate.split('/');
                    const [dayEnd, monthEnd, yearEnd] = rawEndDate.split('/');
                    const startDate = new Date(`${yearStart}-${monthStart}-${dayStart}`);
                    const endDate = new Date(`${yearEnd}-${monthEnd}-${dayEnd}`);
                    endDate.setHours(23, 59, 59, 999);

                    return today >= startDate && today <= endDate;
                });
                setTodayLeaves(currentLeaves);
            } catch (e) {
                console.error("Failed to fetch leave data from Google Sheet:", e);
                setTodayLeaves([]);
            }
        };

        fetchLeaveData();
        const interval = setInterval(fetchLeaveData, 600000);
        return () => clearInterval(interval);
    }, []);

    return (
        <div className="space-y-6">
            <div className="bg-white rounded-2xl shadow-xl p-6 space-y-4 border-t-8 border-indigo-500">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="users" className="w-6 h-6"></i> Pegawai
                    </h2>
                    <div className="flex gap-2">
                        <input type="search" placeholder="Cari pegawai..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                            className="p-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
                        <button onClick={() => setShowCalendar(s => !s)} className="p-2 rounded-full bg-yellow-500 text-white shadow-md hover:bg-yellow-600">
                            <i data-lucide="calendar-days" className="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <div className="bg-gray-100 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-2">
                        <i data-lucide="info" className="w-5 h-5 text-indigo-500"></i>
                        <p className="font-semibold text-gray-700">Pegawai yang sedang cuti hari ini:</p>
                    </div>
                    {todayLeaves.length > 0 ? (
                        <ul className="list-disc list-inside space-y-1 text-sm text-gray-600">
                            {todayLeaves.map((leave, index) => (
                                <li key={index}>{leave['Nama Pegawai']} ({leave['Jenis Cuti']})</li>
                            ))}
                        </ul>
                    ) : (
                        <p className="text-sm text-gray-500 italic">Tidak ada pegawai yang sedang cuti hari ini.</p>
                    )}
                </div>

                {leaveQuotas.length > 0 && (
                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i data-lucide="list" className="w-5 h-5"></i> Aturan Kuota Cuti
                        </h3>
                        <ul className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {leaveQuotas.map(q => (
                                <li key={q.id} className="p-4 bg-gray-50 rounded-lg shadow-sm">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-700 font-semibold">{q.type}</span>
                                        <span className="text-indigo-600 font-bold">{q.quota}</span>
                                    </div>
                                    {q.note && <p className="text-xs italic text-red-500 mt-1">{q.note}</p>}
                                </li>
                            ))}
                        </ul>
                    </div>
                )}
                
                {showCalendar && (
                    <Calendar onClose={() => setShowCalendar(false)} />
                )}

                <div className="space-y-4">
                    {employees.filter(e => e.name.toLowerCase().includes((searchQuery || '').toLowerCase())).map(emp => (
                        <div key={emp.id} className="bg-white rounded-2xl shadow-lg p-6 space-y-4">
                            <h3 className="text-xl font-bold text-gray-800">{emp.name}</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {leaveTypes.map(t => (
                                    <div key={t.key} className="p-4 bg-gray-50 rounded-lg flex flex-col justify-between border-l-4 border-indigo-400">
                                        <div className="flex justify-between items-center">
                                            <span className="text-sm font-medium text-gray-600">{t.label}</span>
                                            {/* Tampilkan ikon catatan jika ada catatan */}
                                            {emp.leaves[t.key]?.notes && (
                                                <button onClick={() => handleShowNotes(emp, t.key)} className="p-1 text-blue-500 hover:text-blue-600">
                                                    <i data-lucide="sticky-note" className="w-5 h-5"></i>
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex items-center space-x-2 mt-2">
                                            <span onClick={() => handleShowNotes(emp, t.key)} className="text-3xl font-bold text-indigo-600 cursor-pointer">{emp.leaves[t.key]?.used ?? 0}</span>
                                            <span className="text-sm text-gray-500">hari</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// Render the application
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
