<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Cuti RRI Sibolga</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase COMPAT (namespaced) to avoid bundlers -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Lucide (browser) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* Prevent FOUC for lucide icons */
    i[data-lucide] { display: inline-block; vertical-align: middle; }
    /* Custom styles for the app */
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #e0e8f0);
    }
    .main-container {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const { createRoot } = ReactDOM;

    // Pastikan variabel global yang disediakan ada, jika tidak, gunakan nilai default
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Inisialisasi Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const db = app.firestore();

    // Tentukan path koleksi Firestore yang benar sesuai dengan aturan keamanan
    const publicDataPath = 'artifacts/' + appId + '/public/data';
    const employeesCollection = db.collection(publicDataPath + '/employees');
    const leaveQuotasCollection = db.collection(publicDataPath + '/leaveQuotas');
    const leaveRequestsCollection = db.collection(publicDataPath + '/leaveRequests');
    const calendarHolidaysCollection = db.collection(publicDataPath + '/calendarHolidays');

    // App constants
    const correctAdminPassword = "rriadmin2025";
    const initialEmployees = ["Yanni Peter Latuheru, S.Sos", "Ichwansyah Pohan, S.E", "Rosmawan Hutabarat, S.E", "Viktor Hamonangan Hutabarat", "Khairil", "Vivi Tri Doharny Daulay", "Diskatarisa Hutabarat", "Novita Sari Putri S.E", "Silverius Hamonangan P. Purba, S.Sos", "Frans Martuani Sinaga, S.M", "Ade Wulan Septyaningsih, S.IP", "Nurhamni Ichwarti, S.Sos", "Citra Priadi Pasaribu, S.IP", "Azis Fahri Tanjung, S.Kom", "Annisa Lestari Nasution, A.Md.Ak", "Putri Andriani, A.Md.Ak", "Mahani Aprilia, A.Md.Ak", "Idola Pratiwi Sinaga, A.md.Pjk", "Ray Wiranta, A.Md.A.B", "Indah Farima Putri, A.Md", "Hans Pierre Sitohang, A.Md", "Sopiah Hasibuan, A.Md", "Aziziah khurfatul Janah, A.Md.Ds", "Astrid khairani Sinaga, A.Md", "Intan Friskila hondro, A.Md", "Anna Theresia Simatupang, S.Sos", "Desi Suriani Pasaribu, S.E", "Rindu Fatmawaty, S.H", "Gerhanawati, S.E", "Ismail Marzuki, S.Sos", "Ronny Ferdian, S.E", "Safran Nuh Nasution, S.T", "M.Khalis Pasaribu, S.Ikom", "Eko Putra Hutabarat, A.Md", "Ahmad Ridho Siregar, A.Md.T", "Ahlis Jami'ah Damanik, A.Md.Kom", "Deliana Nasution", "Widya Sartika Nasution", "Paulus Hadi", "Ahmad Ferdian", "Anhar Rianto Pasaribu", "Deny Siahaan", "Abdul Jalil", "Dedi Hariadi", "Edi Suheri", "Muafdan Jega", "Joyful Rom Sihotang", "James Fransiskus", "Jonni Sihombing", "Martha Monica Putri Siahaan, S.T", "Erni Sasmita, S.E", "Wilson Pangihutan Siregar", "Welly Boy Simatupang, S.E", "Eva Meylina Siahaan", "Flora Susanti Lumbantobing", "Ester Tampubolon", "Bernard Adi Saputra Saragih", "Felix Simatupang", "Mukhtadinul Ikhsan", "Halasson Siahaan", "Mahar Yusuf Sinaga", "Irfan Sihotang", "Rizky Ramadhan Piliang", "Andrian Mendrofa"];

    const leaveTypes = [
      { key: 'annual', label: 'Cuti Tahunan Terpakai' },
      { key: 'long', label: 'Cuti Besar Terpakai' },
      { key: 'sick', label: 'Cuti Sakit Terpakai' },
      { key: 'maternity', label: 'Cuti Melahirkan Terpakai' },
      { key: 'important', label: 'Cuti Alasan Penting Terpakai' },
      { key: 'outside', label: 'Cuti Di Luar Tanggungan Terpakai' },
    ];
    
    function Header({ currentTime }) {
      useEffect(() => { lucide.createIcons(); });
      return (
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
          <div className="flex items-center space-x-4">
            <i data-lucide="radio" className="w-10 h-10 text-indigo-600"></i>
            <h1 className="text-4xl font-bold text-gray-800 tracking-wide">RRI Sibolga</h1>
          </div>
          <div className="text-right">
            <p className="text-lg font-medium text-gray-600">
              {currentTime.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
            </p>
            <p className="text-2xl font-bold text-indigo-600">
              {currentTime.toLocaleTimeString('id-ID')}
            </p>
          </div>
        </div>
      );
    }

    function Calendar({ onClose }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const daysInMonth = useMemo(() => {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const lastDay = new Date(year, month + 1, 0).getDate();
        return Array.from({ length: lastDay }, (_, i) => i + 1);
      }, [currentMonth]);

      const firstDayOffset = useMemo(() => {
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        return firstDay.getDay();
      }, [currentMonth]);

      const monthYear = currentMonth.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

      useEffect(() => { lucide.createIcons(); });

      return (
        <div className="bg-white rounded-2xl shadow-xl p-8 space-y-6 max-w-2xl w-full border-t-8 border-yellow-500">
          <div className="flex items-center justify-between mb-4">
            <button onClick={() => setCurrentMonth(d => new Date(d.getFullYear(), d.getMonth()-1, 1))} className="p-2 rounded-full hover:bg-gray-200">
              <i data-lucide="chevron-left" className="w-6 h-6"></i>
            </button>
            <h3 className="text-xl font-bold text-gray-800">{monthYear}</h3>
            <button onClick={() => setCurrentMonth(d => new Date(d.getFullYear(), d.getMonth()+1, 1))} className="p-2 rounded-full hover:bg-gray-200">
              <i data-lucide="chevron-right" className="w-6 h-6"></i>
            </button>
          </div>
          <div className="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500">
            {['Min','Sen','Sel','Rab','Kam','Jum','Sab'].map(d => <div key={d}>{d}</div>)}
          </div>
          <div className="grid grid-cols-7 gap-2">
            {Array.from({ length: firstDayOffset }).map((_,i)=>(<div key={'e'+i} className="p-2"></div>))}
            {daysInMonth.map(day => (
              <div key={day} className="p-3 bg-gray-100 rounded-lg text-center font-medium transition-all hover:bg-indigo-200 cursor-pointer">
                {day}
              </div>
            ))}
          </div>
          <button onClick={onClose} className="mt-8 w-full flex items-center justify-center px-6 py-3 bg-red-500 text-white font-bold rounded-full text-lg hover:bg-red-600 shadow-lg">
            <i data-lucide="x" className="w-5 h-5 mr-2"></i> Tutup Kalender
          </button>
        </div>
      );
    }
    
    // Komponen modal baru untuk menampilkan dan mengedit catatan
    function NoteModal({ note, onSave, onClose }) {
        const [currentNote, setCurrentNote] = useState(note || '');
        const modalRef = useRef(null);
        
        // Menangani klik di luar modal untuk menutupnya
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (modalRef.current && !modalRef.current.contains(event.target)) {
                    onClose();
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => {
                document.removeEventListener("mousedown", handleClickOutside);
            };
        }, [onClose]);

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div ref={modalRef} className="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
                    <h3 className="text-xl font-bold text-gray-900 mb-4">Catatan Cuti</h3>
                    <textarea
                        value={currentNote}
                        onChange={(e) => setCurrentNote(e.target.value)}
                        className="w-full h-40 p-3 border-2 border-gray-300 rounded-lg resize-none focus:outline-none focus:border-indigo-500"
                        placeholder="Tambahkan catatan cuti di sini..."
                    ></textarea>
                    <div className="flex justify-end gap-2 mt-4">
                        <button
                            onClick={onClose}
                            className="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition"
                        >
                            Batal
                        </button>
                        <button
                            onClick={() => onSave(currentNote)}
                            className="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition"
                        >
                            Simpan
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    function App() {
      const [currentTime, setCurrentTime] = useState(new Date());
      const [isLoading, setIsLoading] = useState(true);
      const [userId, setUserId] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [showPasswordInput, setShowPasswordInput] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [message, setMessage] = useState({ text: '', type: '' });
      const [employees, setEmployees] = useState([]);
      const [leaveQuotas, setLeaveQuotas] = useState([]);
      const [selectedEmployee, setSelectedEmployee] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [editData, setEditData] = useState({});
      const [isSaving, setIsSaving] = useState({});
      const [showFlow, setShowFlow] = useState(false);
      const [showCalendar, setShowCalendar] = useState(false);
      
      // State baru untuk fitur catatan
      const [showNoteModal, setShowNoteModal] = useState(false);
      const [currentNote, setCurrentNote] = useState('');
      const [currentLeaveKey, setCurrentLeaveKey] = useState(null);
      const [currentEmployeeId, setCurrentEmployeeId] = useState(null);

      useEffect(() => { lucide.createIcons(); });

      useEffect(() => {
        const t = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(t);
      }, []);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
          if (!currentUser && initialAuthToken) {
            try {
              await auth.signInWithCustomToken(initialAuthToken);
            } catch (error) {
              console.error("Error signing in with custom token:", error);
              auth.signInAnonymously().catch(anonError => console.error("Anonymous sign-in failed:", anonError));
            }
          }
          setUserId(auth.currentUser ? auth.currentUser.uid : null);
          setIsLoading(false);
        });

        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!userId) return;

        const employeesUnsubscribe = employeesCollection.onSnapshot(
          (snapshot) => {
            const data = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            setEmployees(data);
            if (!selectedEmployee && data.length) setSelectedEmployee(data[0]);
          },
          (error) => {
            console.error("Error fetching employees:", error);
            showModal("Error", "Gagal mengambil data karyawan. Periksa koneksi atau permissions.");
          }
        );

        const quotasUnsubscribe = leaveQuotasCollection.onSnapshot(
          (snapshot) => {
            const data = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            setLeaveQuotas(data);
          },
          (error) => {
            console.error("Error fetching leave quotas:", error);
            showModal("Error", "Gagal mengambil data kuota cuti. Periksa koneksi atau permissions.");
          }
        );

        const ensureSeed = async () => {
          const snap = await employeesCollection.get();
          if (snap.empty) {
            const batch = db.batch();
            initialEmployees.forEach(name => {
              const docRef = employeesCollection.doc();
              batch.set(docRef, {
                name,
                leaves: { 
                    annual:0, 
                    long:0, 
                    sick:0, 
                    maternity:0, 
                    important:0, 
                    outside:0,
                    notes: {} // Inisialisasi notes
                }
              });
            });
            await batch.commit();
          }
        };
        ensureSeed().catch(console.error);

        return () => {
          employeesUnsubscribe();
          quotasUnsubscribe();
        };
      }, [userId]);

      const showModal = (title, message) => {
        setMessage({ text: message, type: title.toLowerCase() });
      };

      const hideMessage = () => {
        setMessage({ text: '', type: '' });
      };

      const getEmployeeById = (id) => employees.find(e => e.id === id);

      const handleRequestLeave = () => {
        showModal('Info', 'Fitur ini akan segera tersedia. Mohon hubungi admin.');
      };

      const filtered = useMemo(
        () => employees.filter(e => e.name.toLowerCase().includes((searchQuery || '').toLowerCase())),
        [employees, searchQuery]
      );

      const toggleAdmin = () => {
        if (isAdmin) {
          setIsAdmin(false); setShowPasswordInput(false); setAdminPassword('');
        } else {
          setShowPasswordInput(true);
        }
        setShowFlow(false); setShowCalendar(false); hideMessage();
      };

      const submitPassword = (e) => {
        e.preventDefault();
        if (adminPassword === correctAdminPassword) {
          setIsAdmin(true); setShowPasswordInput(false); setAdminPassword('');
          showModal("Success", "Berhasil masuk sebagai Admin!");
        } else {
          showModal("Error", "Kata sandi salah.");
        }
      };

      const saveLeaves = async (empId) => {
        setIsSaving(s => ({ ...s, [empId]: true }));
        const emp = employees.find(e => e.id === empId);
        // Pastikan editData memiliki struktur notes
        const newLeaves = { 
            ...emp.leaves, 
            ...(editData[empId] || {}),
            notes: {
                ...(emp.leaves?.notes || {}),
                ...(editData[empId]?.notes || {})
            }
        };

        try {
          await employeesCollection.doc(empId).set({
            ...emp, leaves: newLeaves
          }, { merge: true });
          showModal("Success", "Data cuti disimpan.");
        } catch (error) {
          console.error("Gagal menyimpan data cuti pegawai:", error);
          showModal("Error", "Gagal menyimpan data cuti. Coba lagi.");
        } finally {
          setIsSaving(s => ({ ...s, [empId]: false }));
        }
      };

      const updateQuota = async (id, updatedFields) => {
        try {
          await leaveQuotasCollection.doc(id).set(updatedFields, { merge: true });
          showModal("Success", "Kuota cuti berhasil diperbarui.");
        } catch (error) {
          console.error("Gagal memperbarui kuota cuti:", error);
          showModal("Error", "Gagal memperbarui kuota cuti. Coba lagi.");
        }
      };
      
      const deleteQuota = async (id) => {
        if (!confirm("Hapus jenis cuti ini?")) return;
        try {
            await leaveQuotasCollection.doc(id).delete();
            showModal("Success", "Jenis cuti berhasil dihapus.");
        } catch (error) {
            console.error("Gagal menghapus kuota cuti:", error);
            showModal("Error", "Gagal menghapus kuota cuti. Coba lagi.");
        }
      };

      const addEmployee = async (name) => {
        const nm = (name || '').trim();
        if (!nm) return;
        try {
          await employeesCollection.add({
            name: nm,
            leaves: { annual: 0, long: 0, sick: 0, maternity: 0, important: 0, outside: 0, notes: {} }
          });
          showModal("Success", "Pegawai ditambahkan.");
        } catch (error) {
          console.error("Gagal menambahkan pegawai:", error);
          showModal("Error", "Gagal menambahkan pegawai. Coba lagi.");
        }
      };

      const deleteEmployee = async (emp) => {
        if (!confirm(`Hapus pegawai: ${emp.name}?`)) return;
        try {
          await employeesCollection.doc(emp.id).delete();
          showModal("Success", "Pegawai dihapus.");
        } catch (error) {
          console.error("Gagal menghapus pegawai:", error);
          showModal("Error", "Gagal menghapus pegawai. Coba lagi.");
        }
      };

      const updateName = async (empId, newName) => {
        const nm = (newName || '').trim();
        if (!nm) return;
        try {
          await employeesCollection.doc(empId).set({ name: nm }, { merge: true });
          showModal("Success", "Nama diperbarui.");
        } catch (error) {
          console.error("Gagal memperbarui nama:", error);
          showModal("Error", "Gagal memperbarui nama. Coba lagi.");
        }
      };

      // Fungsi untuk menampilkan modal catatan
      const showNote = (employeeId, leaveKey) => {
        const employee = employees.find(e => e.id === employeeId);
        const note = employee?.leaves?.notes?.[leaveKey] || '';
        setCurrentEmployeeId(employeeId);
        setCurrentLeaveKey(leaveKey);
        setCurrentNote(note);
        setShowNoteModal(true);
      };

      // Fungsi untuk menyimpan catatan ke Firestore
      const handleSaveNote = async (note) => {
        if (!currentEmployeeId || !currentLeaveKey) return;
        const emp = employees.find(e => e.id === currentEmployeeId);
        const newLeavesNotes = { ...(emp.leaves?.notes || {}), [currentLeaveKey]: note };
        try {
            await employeesCollection.doc(currentEmployeeId).set({
                leaves: { notes: newLeavesNotes }
            }, { merge: true });
            showModal("Success", "Catatan berhasil disimpan.");
        } catch (error) {
            console.error("Gagal menyimpan catatan:", error);
            showModal("Error", "Gagal menyimpan catatan. Coba lagi.");
        } finally {
            setShowNoteModal(false);
            setCurrentNote('');
            setCurrentEmployeeId(null);
            setCurrentLeaveKey(null);
        }
      };

      // UI
      if (isLoading) return (
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-xl font-semibold text-gray-700 animate-pulse">Memuat dataâ€¦</div>
        </div>
      );

      return (
        <div className="max-w-7xl mx-auto p-4">
          <Header currentTime={currentTime} />
          {message.text && (
            <div className={`p-4 mb-4 text-white rounded-lg shadow-md flex items-center justify-between ${message.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
              <span>{message.text}</span>
              <button onClick={hideMessage} className="ml-4 p-1 rounded-full hover:bg-white/20">
                <i data-lucide="x" className="w-5 h-5"></i>
              </button>
            </div>
          )}
          <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div className="flex items-center gap-2 bg-gray-100 p-3 rounded-xl text-gray-600 text-sm">
              <span className="font-semibold">ID Aplikasi:</span>
              <span className="font-mono break-all">{appId}</span>
            </div>
            <div className="flex flex-col items-end gap-2">
              <button onClick={toggleAdmin} className={`px-6 py-2 rounded-full font-bold text-white shadow-lg ${isAdmin ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-500 hover:bg-indigo-600'}`}>
                {isAdmin ? 'Beralih ke User' : 'Beralih ke Admin'}
              </button>
              {showPasswordInput && (
                <form onSubmit={submitPassword} className="flex gap-2">
                  <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} placeholder="Kata sandi admin" className="p-2 border-2 border-gray-300 rounded-full focus:border-indigo-500 focus:outline-none" />
                  <button type="submit" className="px-4 py-2 bg-green-500 text-white rounded-full font-semibold hover:bg-green-600">Masuk</button>
                </form>
              )}
            </div>
          </div>
          {isAdmin ? (
            <AdminPanel
              employees={employees}
              leaveTypes={leaveTypes}
              leaveQuotas={leaveQuotas}
              editData={editData}
              setEditData={setEditData}
              saveLeaves={saveLeaves}
              updateQuota={updateQuota}
              deleteQuota={deleteQuota}
              addEmployee={addEmployee}
              deleteEmployee={deleteEmployee}
              updateName={updateName}
              isSaving={isSaving}
              showNote={showNote}
            />
          ) : (
            <UserPanel
              employees={employees}
              selectedEmployee={selectedEmployee}
              setSelectedEmployee={setSelectedEmployee}
              leaveTypes={leaveTypes}
              leaveQuotas={leaveQuotas}
              searchQuery={searchQuery}
              setSearchQuery={setSearchQuery}
              showFlow={showFlow}
              setShowFlow={setShowFlow}
              showCalendar={showCalendar}
              setShowCalendar={setShowCalendar}
            />
          )}
          {/* Modal Catatan */}
          {showNoteModal && (
            <NoteModal
                note={currentNote}
                onSave={handleSaveNote}
                onClose={() => setShowNoteModal(false)}
            />
          )}
        </div>
      );
    }
    
    function UserPanel({ employees, selectedEmployee, setSelectedEmployee, leaveTypes, leaveQuotas, searchQuery, setSearchQuery, showFlow, setShowFlow, showCalendar, setShowCalendar }) {
      useEffect(() => { lucide.createIcons(); });
      const filteredEmployees = useMemo(
        () => employees.filter(e => e.name.toLowerCase().includes((searchQuery || '').toLowerCase())),
        [employees, searchQuery]
      );
      return (
        <div className="space-y-6">
          <div className="bg-white rounded-2xl shadow-xl p-6 border-t-8 border-indigo-500">
            <h3 className="text-xl font-bold text-gray-800 text-center mb-4">Pilih Pegawai</h3>
            <div className="flex flex-col items-center">
              <input
                type="text"
                placeholder="Cari Pegawai..."
                value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)}
                className="w-full max-w-sm px-4 py-2 border border-gray-300 rounded-full shadow-inner focus:outline-none focus:border-indigo-500"
              />
              <div className="mt-4 w-full max-w-sm max-h-64 overflow-y-auto bg-gray-50 rounded-lg shadow-inner">
                {filteredEmployees.map(emp => (
                  <div key={emp.id} onClick={() => setSelectedEmployee(emp)} className={`p-3 cursor-pointer hover:bg-indigo-100 transition-colors ${selectedEmployee && selectedEmployee.id === emp.id ? 'bg-indigo-200 font-semibold' : ''}`}>
                    {emp.name}
                  </div>
                ))}
              </div>
            </div>
          </div>
          {selectedEmployee && (
            <div className="bg-white rounded-2xl shadow-xl p-6 border-t-8 border-yellow-500">
              <h3 className="text-2xl font-bold text-gray-800 text-center mb-4">{selectedEmployee.name}</h3>
              <div className="space-y-4">
                {leaveTypes.map(type => (
                  <div key={type.key} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm">
                    <div className="font-semibold text-gray-700">{type.label}</div>
                    <div className="text-gray-500">{selectedEmployee.leaves[type.key] || 0} hari</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          <div className="bg-white rounded-2xl shadow-xl p-6 mt-6 space-y-4 border-t-8 border-teal-500">
            <div className="flex flex-col md:flex-row gap-4 mt-6">
              <button onClick={() => setShowFlow(true)} className="flex-1 w-full flex items-center justify-center px-6 py-3 bg-gray-500 text-white font-bold rounded-full text-lg hover:bg-gray-600 shadow">
                <i data-lucide="clock" className="w-5 h-5 mr-2"></i> Lihat Alur Cuti
              </button>
              <button onClick={() => setShowCalendar(true)} className="flex-1 w-full flex items-center justify-center px-6 py-3 bg-teal-500 text-white font-bold rounded-full text-lg hover:bg-teal-600 shadow">
                <i data-lucide="calendar-days" className="w-5 h-5 mr-2"></i> Lihat Kalender
              </button>
            </div>
            {showFlow ? (
              <div className="bg-white rounded-2xl p-4 mt-4 border border-gray-200">
                <h3 className="text-xl font-bold text-gray-800 text-center mb-4">Alur Pengajuan Cuti</h3>
                <ol className="list-decimal list-inside space-y-2 text-gray-700">
                  <li>Karyawan mengajukan permohonan cuti.</li>
                  <li>Manajer/Atasan menyetujui atau menolak permohonan.</li>
                  <li>Jika disetujui, cuti dicatat dan kuota diperbarui.</li>
                  <li>Status permohonan dapat dilihat secara real-time.</li>
                </ol>
                <button onClick={() => setShowFlow(false)} className="mt-4 w-full flex items-center justify-center px-6 py-3 bg-gray-500 text-white font-bold rounded-full text-lg hover:bg-gray-600 shadow">
                  <i data-lucide="arrow-left" className="w-5 h-5 mr-2"></i> Kembali
                </button>
              </div>
            ) : showCalendar ? (
              <Calendar onClose={() => setShowCalendar(false)} />
            ) : null}
          </div>
        </div>
      );
    }
    
    function AdminPanel({ employees, leaveTypes, leaveQuotas, editData, setEditData, saveLeaves, updateQuota, deleteQuota, addEmployee, deleteEmployee, updateName, isSaving, showNote }) {
      useEffect(() => { lucide.createIcons(); });
      const [newEmployeeName, setNewEmployeeName] = useState('');
      const [newQuotaType, setNewQuotaType] = useState('');
      const [newQuotaValue, setNewQuotaValue] = useState('');
      
      const handleAddEmployee = () => { addEmployee(newEmployeeName); setNewEmployeeName(''); };
      const handleAddQuota = () => { updateQuota(null, { type: newQuotaType, quota: newQuotaValue, order: leaveQuotas.length + 1 }); setNewQuotaType(''); setNewQuotaValue(''); };
    
      return (
        <div className="space-y-8">
            {/* Tabel Karyawan */}
            <div className="bg-white rounded-2xl shadow-xl p-6 border-t-8 border-indigo-500 overflow-x-auto">
                <h3 className="text-2xl font-bold text-gray-800 text-center mb-6">Manajemen Data Karyawan</h3>
                <div className="flex gap-2 mb-4">
                    <input
                        type="text"
                        value={newEmployeeName}
                        onChange={(e) => setNewEmployeeName(e.target.value)}
                        placeholder="Nama Pegawai Baru"
                        className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                    />
                    <button onClick={handleAddEmployee} className="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                        Tambah Pegawai
                    </button>
                </div>
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pegawai</th>
                            {leaveTypes.map(lt => (
                                <th key={lt.key} className="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{lt.label}</th>
                            ))}
                            <th className="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {employees.map(emp => (
                            <tr key={emp.id} className="hover:bg-gray-50">
                                <td className="p-3 whitespace-nowrap">
                                    <input
                                        type="text"
                                        value={editData[emp.id]?.name ?? emp.name}
                                        onChange={e => setEditData(d => ({ ...d, [emp.id]: { ...d[emp.id], name: e.target.value } }))}
                                        onBlur={() => updateName(emp.id, editData[emp.id]?.name)}
                                        className="p-1 w-full border border-transparent rounded hover:border-gray-300 focus:border-indigo-500 focus:outline-none"
                                    />
                                </td>
                                {leaveTypes.map(lt => (
                                    <td key={lt.key} className="p-3 whitespace-nowrap text-sm text-gray-900 text-center">
                                        <div className="flex items-center justify-center gap-2">
                                            <input
                                                type="number"
                                                min="0"
                                                value={editData[emp.id]?.leaves?.[lt.key] ?? emp.leaves[lt.key] ?? 0}
                                                onChange={e => setEditData(d => ({ 
                                                    ...d, 
                                                    [emp.id]: { 
                                                        ...d[emp.id], 
                                                        leaves: { ...d[emp.id]?.leaves, [lt.key]: parseInt(e.target.value) || 0 }
                                                    } 
                                                }))}
                                                className="p-1 w-16 text-center border-2 border-gray-300 rounded focus:border-indigo-500 focus:outline-none"
                                            />
                                            {/* Tombol catatan */}
                                            {(editData[emp.id]?.leaves?.[lt.key] > 0 || emp.leaves[lt.key] > 0) && (
                                                <button
                                                    onClick={() => showNote(emp.id, lt.key)}
                                                    className="p-1 text-gray-500 hover:text-gray-900 transition-colors"
                                                    title="Lihat Catatan"
                                                >
                                                    <i data-lucide="clipboard-pen" className="w-5 h-5"></i>
                                                </button>
                                            )}
                                        </div>
                                    </td>
                                ))}
                                <td className="p-3 text-center whitespace-nowrap">
                                    <div className="flex justify-center items-center gap-2">
                                        <button onClick={() => saveLeaves(emp.id)} disabled={isSaving[emp.id]} className="px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded-full hover:bg-green-600 transition-colors disabled:opacity-50">
                                            {isSaving[emp.id] ? 'Menyimpan...' : 'Simpan'}
                                        </button>
                                        <button onClick={() => deleteEmployee(emp)} className="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-full hover:bg-red-600 transition-colors">
                                            Hapus
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Manajemen Kuota Cuti */}
            <div className="bg-white rounded-2xl shadow-xl p-6 border-t-8 border-yellow-500">
                <h3 className="text-2xl font-bold text-gray-800 text-center mb-6">Manajemen Kuota Cuti</h3>
                <div className="flex gap-2 mb-4">
                    <input
                        type="text"
                        value={newQuotaType}
                        onChange={e => setNewQuotaType(e.target.value)}
                        placeholder="Jenis Cuti Baru"
                        className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                    />
                    <input
                        type="text"
                        value={newQuotaValue}
                        onChange={e => setNewQuotaValue(e.target.value)}
                        placeholder="Kuota (ex: 12 hari)"
                        className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500"
                    />
                    <button onClick={handleAddQuota} className="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                        Tambah Kuota
                    </button>
                </div>
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Cuti</th>
                            <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kuota</th>
                            <th className="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {leaveQuotas.map(q => (
                            <tr key={q.id}>
                                <td className="p-3 text-sm text-gray-900">
                                    <input
                                        type="text"
                                        value={q.type}
                                        onChange={e => setLeaveQuotas(prev => prev.map(item => item.id === q.id ? { ...item, type: e.target.value } : item))}
                                        onBlur={e => updateQuota(q.id, { type: e.target.value })}
                                        className="p-1 w-full border border-transparent rounded hover:border-gray-300 focus:border-indigo-500 focus:outline-none"
                                    />
                                </td>
                                <td className="p-3 text-sm text-gray-900">
                                    <input
                                        type="text"
                                        value={q.quota}
                                        onChange={e => setLeaveQuotas(prev => prev.map(item => item.id === q.id ? { ...item, quota: e.target.value } : item))}
                                        onBlur={e => updateQuota(q.id, { quota: e.target.value })}
                                        className="p-1 w-full border border-transparent rounded hover:border-gray-300 focus:border-indigo-500 focus:outline-none"
                                    />
                                </td>
                                <td className="p-3 text-center">
                                    <button onClick={() => deleteQuota(q.id)} className="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-full hover:bg-red-600 transition-colors">
                                        Hapus
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
      );
    }
    
    // Render aplikasi
    createRoot(document.getElementById('root')).render(<App />);

    // Inisialisasi ikon Lucide setelah React selesai merender
    window.addEventListener('load', () => {
      lucide.createIcons();
    });
  </script>
</body>
</html>
